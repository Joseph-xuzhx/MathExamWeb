@page "/category-management"
@using MathExamWeb.Data
@using MathExamWeb.Data.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject MathExamDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="container">
    <div class="exam-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-6">ğŸ“‚ åˆ†ç±»ç®¡ç†</h1>
            <div>
                <button class="btn btn-success me-2" @onclick="ShowAddModal">
                    â• æ·»åŠ åˆ†ç±»
                </button>
                <button class="btn btn-warning me-2" @onclick="ImportFromQuestions">
                    ğŸ“¥ ä»é¢˜åº“å¯¼å…¥
                </button>
                <a href="/question-bank" class="btn btn-outline-secondary">
                    â† è¿”å›é¢˜åº“
                </a>
            </div>
        </div>

        <!-- ç­›é€‰åŒºåŸŸ -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">ğŸ“– ç§‘ç›®</label>
                        <select class="form-select" @bind="FilterSubject" @bind:after="LoadCategories">
                            <option value="">å…¨éƒ¨</option>
                            <option value="chinese">è¯­æ–‡</option>
                            <option value="math">æ•°å­¦</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ğŸ“Š çŠ¶æ€</label>
                        <select class="form-select" @bind="FilterStatus" @bind:after="LoadCategories">
                            <option value="">å…¨éƒ¨</option>
                            <option value="active">å¯ç”¨</option>
                            <option value="inactive">ç¦ç”¨</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†ç±»åˆ—è¡¨ -->
        @if (IsLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
            </div>
        }
        else if (!Categories.Any())
        {
            <div class="alert alert-info text-center">
                ğŸ“­ æš‚æ— åˆ†ç±»æ•°æ®
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 80px;">æ’åº</th>
                            <th style="width: 100px;">ç§‘ç›®</th>
                            <th style="width: 150px;">åˆ†ç»„</th>
                            <th>åˆ†ç±»åç§°</th>
                            <th style="width: 80px;">çŠ¶æ€</th>
                            <th style="width: 150px;">åˆ›å»ºæ—¶é—´</th>
                            <th style="width: 180px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var category in Categories)
                        {
                            <tr>
                                <td>@category.SortOrder</td>
                                <td>
                                    <span class="badge bg-@(category.Subject == "math" ? "primary" : "success")">
                                        @(category.Subject == "math" ? "æ•°å­¦" : "è¯­æ–‡")
                                    </span>
                                </td>
                                <td>@category.GroupName</td>
                                <td style="white-space: nowrap;"><strong>@category.Name</strong></td>
                                <td>
                                    @if (category.IsActive)
                                    {
                                        <span class="badge bg-success">å¯ç”¨</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">ç¦ç”¨</span>
                                    }
                                </td>
                                <td>@category.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd")</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ShowEditModal(category)">
                                        âœï¸ ç¼–è¾‘
                                    </button>
                                    @if (category.IsActive)
                                    {
                                        <button class="btn btn-sm btn-outline-warning me-1" @onclick="() => ToggleStatus(category)">
                                            ğŸ”’ ç¦ç”¨
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-success me-1" @onclick="() => ToggleStatus(category)">
                                            ğŸ”“ å¯ç”¨
                                        </button>
                                    }
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteCategory(category)">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="alert alert-info">
                ğŸ“Š å…± <strong>@Categories.Count</strong> ä¸ªåˆ†ç±»
            </div>
        }

        @if (!string.IsNullOrEmpty(SuccessMessage))
        {
            <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                âœ… @SuccessMessage
                <button type="button" class="btn-close" @onclick="() => SuccessMessage = string.Empty"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                âŒ @ErrorMessage
                <button type="button" class="btn-close" @onclick="() => ErrorMessage = string.Empty"></button>
            </div>
        }
    </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘åˆ†ç±»æ¨¡æ€æ¡† -->
@if (ShowModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(IsEditing ? "âœï¸ ç¼–è¾‘åˆ†ç±»" : "â• æ·»åŠ åˆ†ç±»")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ç§‘ç›® <span class="text-danger">*</span></label>
                        <select class="form-select" @bind="EditingCategory.Subject">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="chinese">è¯­æ–‡</option>
                            <option value="math">æ•°å­¦</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">åˆ†ç±»åç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" @bind="EditingCategory.Name"
                               placeholder="ä¾‹å¦‚ï¼šåŠ æ³•ã€å¤è¯—è¯ç­‰" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">åˆ†ç»„åç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" @bind="EditingCategory.GroupName"
                               placeholder="ä¾‹å¦‚ï¼šåŸºç¡€è¿ç®—ã€å¤è¯—æ–‡ç­‰" />
                        <small class="text-muted">åŒä¸€åˆ†ç»„çš„åˆ†ç±»ä¼šæ˜¾ç¤ºåœ¨ä¸€èµ·</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ’åºåºå·</label>
                        <input type="number" class="form-control" @bind="EditingCategory.SortOrder"
                               placeholder="æ•°å­—è¶Šå°è¶Šé å‰" />
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="EditingCategory.IsActive" id="isActive">
                            <label class="form-check-label" for="isActive">
                                å¯ç”¨æ­¤åˆ†ç±»
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveCategory">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<CategoryEntity> Categories = new();
    private string FilterSubject = "";
    private string FilterStatus = "";
    private bool IsLoading = false;
    private string SuccessMessage = "";
    private string ErrorMessage = "";

    private bool ShowModal = false;
    private bool IsEditing = false;
    private CategoryEntity EditingCategory = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        IsLoading = true;
        try
        {
            var query = DbContext.Categories.AsQueryable();

            if (!string.IsNullOrEmpty(FilterSubject))
            {
                query = query.Where(c => c.Subject == FilterSubject);
            }

            if (FilterStatus == "active")
            {
                query = query.Where(c => c.IsActive);
            }
            else if (FilterStatus == "inactive")
            {
                query = query.Where(c => !c.IsActive);
            }

            Categories = await query.OrderBy(c => c.Subject).ThenBy(c => c.SortOrder).ToListAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"åŠ è½½å¤±è´¥ï¼š{ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void ShowAddModal()
    {
        IsEditing = false;
        EditingCategory = new CategoryEntity
        {
            IsActive = true,
            SortOrder = 0
        };
        ShowModal = true;
    }

    private void ShowEditModal(CategoryEntity category)
    {
        IsEditing = true;
        EditingCategory = new CategoryEntity
        {
            Id = category.Id,
            Subject = category.Subject,
            Name = category.Name,
            GroupName = category.GroupName,
            SortOrder = category.SortOrder,
            IsActive = category.IsActive,
            CreatedAt = category.CreatedAt
        };
        ShowModal = true;
    }

    private void CloseModal()
    {
        ShowModal = false;
        EditingCategory = new();
    }

    private async Task SaveCategory()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(EditingCategory.Subject))
            {
                ErrorMessage = "è¯·é€‰æ‹©ç§‘ç›®";
                return;
            }

            if (string.IsNullOrWhiteSpace(EditingCategory.Name))
            {
                ErrorMessage = "è¯·è¾“å…¥åˆ†ç±»åç§°";
                return;
            }

            if (string.IsNullOrWhiteSpace(EditingCategory.GroupName))
            {
                ErrorMessage = "è¯·è¾“å…¥åˆ†ç»„åç§°";
                return;
            }

            if (IsEditing)
            {
                var existing = await DbContext.Categories.FindAsync(EditingCategory.Id);
                if (existing != null)
                {
                    existing.Subject = EditingCategory.Subject;
                    existing.Name = EditingCategory.Name;
                    existing.GroupName = EditingCategory.GroupName;
                    existing.SortOrder = EditingCategory.SortOrder;
                    existing.IsActive = EditingCategory.IsActive;
                    existing.UpdatedAt = DateTime.UtcNow;
                }
            }
            else
            {
                EditingCategory.CreatedAt = DateTime.UtcNow;
                EditingCategory.UpdatedAt = DateTime.UtcNow;
                await DbContext.Categories.AddAsync(EditingCategory);
            }

            await DbContext.SaveChangesAsync();
            SuccessMessage = IsEditing ? "åˆ†ç±»æ›´æ–°æˆåŠŸ" : "åˆ†ç±»æ·»åŠ æˆåŠŸ";
            CloseModal();
            await LoadCategories();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"ä¿å­˜å¤±è´¥ï¼š{ex.Message}";
        }
    }

    private async Task ToggleStatus(CategoryEntity category)
    {
        try
        {
            var existing = await DbContext.Categories.FindAsync(category.Id);
            if (existing != null)
            {
                existing.IsActive = !existing.IsActive;
                existing.UpdatedAt = DateTime.UtcNow;
                await DbContext.SaveChangesAsync();
                SuccessMessage = existing.IsActive ? "åˆ†ç±»å·²å¯ç”¨" : "åˆ†ç±»å·²ç¦ç”¨";
                await LoadCategories();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"æ“ä½œå¤±è´¥ï¼š{ex.Message}";
        }
    }

    private async Task DeleteCategory(CategoryEntity category)
    {
        try
        {
            bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"ç¡®å®šè¦åˆ é™¤åˆ†ç±» {category.Name} å—ï¼Ÿ");
            if (!confirmed)
            {
                return;
            }

            var existing = await DbContext.Categories.FindAsync(category.Id);
            if (existing != null)
            {
                DbContext.Categories.Remove(existing);
                await DbContext.SaveChangesAsync();
                SuccessMessage = "åˆ†ç±»åˆ é™¤æˆåŠŸ";
                await LoadCategories();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"åˆ é™¤å¤±è´¥ï¼š{ex.Message}";
        }
    }

    private async Task ImportFromQuestions()
    {
        try
        {
            bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
                "å°†ä»é¢˜åº“ä¸­æ±‡æ€»æ‰€æœ‰åˆ†ç±»å¹¶å¯¼å…¥åˆ°åˆ†ç±»å­—å…¸è¡¨ä¸­ï¼ˆå·²å­˜åœ¨çš„ä¸ä¼šé‡å¤å¯¼å…¥ï¼‰ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ");

            if (!confirmed)
            {
                return;
            }

            IsLoading = true;

            // ä»é¢˜åº“è¡¨ä¸­æ±‡æ€»æ‰€æœ‰ä¸åŒçš„ç§‘ç›®å’Œåˆ†ç±»ç»„åˆ
            var questionCategories = await DbContext.Questions
                .Where(q => !string.IsNullOrEmpty(q.Category) && !string.IsNullOrEmpty(q.Subject))
                .Select(q => new { q.Subject, q.Category })
                .Distinct()
                .ToListAsync();

            int addedCount = 0;
            int skippedCount = 0;

            foreach (var item in questionCategories)
            {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                var exists = await DbContext.Categories
                    .AnyAsync(c => c.Subject == item.Subject && c.Name == item.Category);

                if (!exists)
                {
                    // æ¨æ–­åˆ†ç»„åç§°
                    string groupName = InferGroupName(item.Category);

                    // è®¡ç®—æ’åºåºå·ï¼ˆåŒä¸€åˆ†ç»„å†…çš„æœ€å¤§åºå·+1ï¼‰
                    var existingCategories = await DbContext.Categories
                        .Where(c => c.Subject == item.Subject && c.GroupName == groupName)
                        .Select(c => c.SortOrder)
                        .ToListAsync();

                    int sortOrder = existingCategories.Any() ? existingCategories.Max() + 1 : 1;

                    var newCategory = new CategoryEntity
                    {
                        Subject = item.Subject,
                        Name = item.Category,
                        GroupName = groupName,
                        SortOrder = sortOrder,
                        IsActive = true,
                        CreatedAt = DateTime.UtcNow,
                        UpdatedAt = DateTime.UtcNow
                    };

                    await DbContext.Categories.AddAsync(newCategory);
                    addedCount++;
                }
                else
                {
                    skippedCount++;
                }
            }

            await DbContext.SaveChangesAsync();
            SuccessMessage = $"å¯¼å…¥å®Œæˆï¼æ–°å¢ {addedCount} ä¸ªåˆ†ç±»ï¼Œè·³è¿‡ {skippedCount} ä¸ªå·²å­˜åœ¨çš„åˆ†ç±»ã€‚";
            await LoadCategories();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"å¯¼å…¥å¤±è´¥ï¼š{ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private string InferGroupName(string categoryName)
    {
        // æ ¹æ®åˆ†ç±»åç§°æ¨æ–­åˆ†ç»„
        if (categoryName.Contains("åŠ æ³•") || categoryName.Contains("å‡æ³•") ||
            categoryName.Contains("ä¹˜æ³•") || categoryName.Contains("é™¤æ³•") ||
            categoryName.Contains("æ··åˆè¿ç®—"))
        {
            return "åŸºç¡€è¿ç®—";
        }
        else if (categoryName.Contains("åˆ†æ•°"))
        {
            return "åˆ†æ•°è¿ç®—";
        }
        else if (categoryName.Contains("åº”ç”¨é¢˜"))
        {
            return "åº”ç”¨é¢˜";
        }
        else if (categoryName.Contains("ç™¾åˆ†æ•°") || categoryName.Contains("å°æ•°") ||
                 categoryName.Contains("å‡ ä½•") || categoryName.Contains("ç»Ÿè®¡") ||
                 categoryName.Contains("æ¯”å’Œæ¯”ä¾‹"))
        {
            return "å…¶ä»–";
        }
        else if (categoryName.Contains("å¤è¯—") || categoryName.Contains("åå¥") ||
                 categoryName.Contains("æ–‡è¨€æ–‡"))
        {
            return "å¤è¯—æ–‡";
        }
        else if (categoryName.Contains("è¿‘ä¹‰è¯") || categoryName.Contains("åä¹‰è¯") ||
                 categoryName.Contains("æˆè¯­") || categoryName.Contains("è¯è¯­"))
        {
            return "è¯æ±‡";
        }
        else if (categoryName.Contains("ä¿®è¾") || categoryName.Contains("ç—…å¥") ||
                 categoryName.Contains("æ ‡ç‚¹") || categoryName.Contains("å¥å¼"))
        {
            return "è¯­æ³•";
        }
        else if (categoryName.Contains("é˜…è¯»"))
        {
            return "é˜…è¯»ç†è§£";
        }
        else
        {
            return "å…¶ä»–";
        }
    }
}
