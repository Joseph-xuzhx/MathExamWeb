@page "/math"
@using MathExamWeb.Data
@using MathExamWeb.Data.Models
@using MathExamWeb.Data.Services
@using MathExamWeb.Data.Services.Interfaces
@using System.Text.Json
@inherits MathExamWeb.Components.Base.BaseExamComponent<MathQuestionService>

<div class="container">
    <div class="exam-card">
        <div class="text-center mb-4">
            <h1 class="display-6">æ¸©å·å¸‚é¹¿åŸåŒºå°å­¦å…­å¹´çº§<br/>@GetSubjectName()æ™ºèƒ½è€ƒåœº</h1>
            @if (Started)
            {
                <div class="score-board mt-3">
                    å¾—åˆ†ï¼š@Score / @(TargetCount * 10)ï¼ˆè¿›åº¦ @Asked.Count/@TargetCountï¼‰
                </div>
                <div class="mt-2">
                    <button class="btn btn-outline-warning btn-sm me-2" @onclick="ResetToStart">é‡æ–°å¼€å§‹</button>
                    <a class="btn btn-outline-secondary btn-sm" href="/">è¿”å›é€‰æ‹©</a>
                </div>
            }
        </div>

        @if (!Started)
        {
            <div class="p-4 border rounded bg-light">
                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©è€ƒè¯•æ¨¡å¼</label>
                    <div class="btn-group d-flex mb-2" role="group">
                        <input type="radio" class="btn-check" name="examMode" id="modeSequential"
                               checked="@(SelectedExamMode == ExamMode.Sequential)"
                               @onclick="@(() => SelectedExamMode = ExamMode.Sequential)" />
                        <label class="btn btn-outline-info" for="modeSequential">
                            ğŸ“ é€é¢˜æ¨¡å¼<br/>
                            <small class="text-muted">ä¸€é¢˜ä¸€é¢˜åšï¼Œå³æ—¶æŸ¥çœ‹ç»“æœ</small>
                        </label>

                        <input type="radio" class="btn-check" name="examMode" id="modePaper"
                               checked="@(SelectedExamMode == ExamMode.Paper)"
                               @onclick="@(() => SelectedExamMode = ExamMode.Paper)" />
                        <label class="btn btn-outline-warning" for="modePaper">
                            ğŸ“„ è¯•å·æ¨¡å¼<br/>
                            <small class="text-muted">ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰é¢˜ç›®åç»Ÿä¸€æäº¤</small>
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©éš¾åº¦çº§åˆ«</label>
                    <div class="btn-group d-flex" role="group">
                        <input type="radio" class="btn-check" name="difficulty" id="diffEasy"
                               checked="@(SelectedDifficulty == DifficultyLevel.Easy)"
                               @onclick="@(() => SelectedDifficulty = DifficultyLevel.Easy)" />
                        <label class="btn btn-outline-success" for="diffEasy">ç®€å•</label>

                        <input type="radio" class="btn-check" name="difficulty" id="diffMedium"
                               checked="@(SelectedDifficulty == DifficultyLevel.Medium)"
                               @onclick="@(() => SelectedDifficulty = DifficultyLevel.Medium)" />
                        <label class="btn btn-outline-primary" for="diffMedium">ä¸­ç­‰</label>

                        <input type="radio" class="btn-check" name="difficulty" id="diffHard"
                               checked="@(SelectedDifficulty == DifficultyLevel.Hard)"
                               @onclick="@(() => SelectedDifficulty = DifficultyLevel.Hard)" />
                        <label class="btn btn-outline-danger" for="diffHard">å›°éš¾</label>

                        <input type="radio" class="btn-check" name="difficulty" id="diffRandom"
                               checked="@(SelectedDifficulty == null)"
                               @onclick="@(() => SelectedDifficulty = null)" />
                        <label class="btn btn-outline-secondary" for="diffRandom">éšæœº</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">è®¾å®šæœ¬æ¬¡æµ‹è¯•é¢˜ç›®æ•°é‡</label>
                    <input type="number" class="form-control" min="1" max="50" @bind="TargetCount" />
                </div>

                <button class="btn btn-primary btn-lg" @onclick="StartExam">å¼€å§‹æµ‹è¯•</button>
                <a class="btn btn-outline-secondary btn-lg ms-2" href="/">è¿”å›é€‰æ‹©</a>
            </div>
        }
        else if (Finished)
        {
            <div class="p-4 border rounded bg-light">
                <h4>æœ¬æ¬¡æµ‹è¯•å·²å®Œæˆ</h4>
                <p class="fs-5">æ€»åˆ†ï¼š<strong>@Score</strong> / @(TargetCount * 10)</p>
                <p>æ­£ç¡®ç‡ï¼š<strong>@((Asked.Count(a => a.Correct) * 100.0 / Asked.Count).ToString("F1"))%</strong></p>

                <div class="d-flex flex-wrap gap-2 mt-3">
                    <button class="btn btn-success" @onclick="StartExam">é‡æ–°å¼€å§‹</button>
                    <button class="btn btn-outline-primary" @onclick="ToggleReview">æŸ¥çœ‹å¤ä¹ åˆ—è¡¨</button>
                    <a class="btn btn-outline-info" href="/exam-history">ğŸ“ å†æ¬¡è®°å½•</a>
                    <a class="btn btn-info" href="/statistics/@GetStoragePrefix()">ğŸ“Š ç»Ÿè®¡æŠ¥å‘Š</a>
                    <a class="btn btn-warning" href="/wrong-questions/@GetStoragePrefix()">ğŸ“– é”™é¢˜æœ¬</a>
                </div>

                @if (ShowReview)
                {
                    <div class="mt-3">
                        <h5>æœ¬æ¬¡è¯•é¢˜å›é¡¾</h5>
                        @foreach (var item in Asked)
                        {
                            <div class="border rounded p-3 mb-2">
                                <div><strong>é¢˜ç›®ï¼š</strong>@item.Q.Text</div>
                                <div><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong>@item.Q.CorrectAnswer</div>
                                <div><strong>ä½ çš„ç­”æ¡ˆï¼š</strong>@item.User</div>
                                <div><strong>æ˜¯å¦æ­£ç¡®ï¼š</strong>@(item.Correct ? "æ˜¯" : "å¦")</div>
                                <div class="mt-2">@item.Q.Explanation</div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else if (SelectedExamMode == ExamMode.Paper && AllQuestions.Any())
        {
            <!-- è¯•å·æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰é¢˜ç›® -->
            <div class="paper-mode-section">
                @if (!PaperSubmitted)
                {
                    <div class="alert alert-info">
                        <strong>ğŸ“„ è¯•å·æ¨¡å¼</strong> - è¯·å®Œæˆæ‰€æœ‰é¢˜ç›®åç‚¹å‡»"æäº¤è¯•å·"æŒ‰é’®ç»Ÿä¸€æ‰¹æ”¹
                    </div>

                    @for (int i = 0; i < AllQuestions.Count; i++)
                    {
                        var index = i; // é—­åŒ…å˜é‡
                        var question = AllQuestions[i];

                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong>ç¬¬ @(i + 1) é¢˜</strong>
                                @if (question.Type == QuestionType.MultipleChoice)
                                {
                                    <span class="badge bg-info ms-2">é€‰æ‹©é¢˜</span>
                                }
                                else
                                {
                                    <span class="badge bg-success ms-2">å¡«ç©ºé¢˜</span>
                                }
                            </div>
                            <div class="card-body">
                                <p class="card-text">@question.Text</p>

                                @if (question.Type == QuestionType.MultipleChoice)
                                {
                                    <!-- é€‰æ‹©é¢˜ï¼šæ˜¾ç¤ºé€‰é¡¹ -->
                                    <div class="list-group">
                                        @for (int optIdx = 0; optIdx < question.ShuffledOptions.Count; optIdx++)
                                        {
                                            var option = question.ShuffledOptions[optIdx];
                                            var letter = ((char)('A' + optIdx)).ToString();
                                            <label class="list-group-item list-group-item-action" style="cursor: pointer;">
                                                <input class="form-check-input me-2" type="radio"
                                                       name="paper_answer_@i"
                                                       value="@letter"
                                                       checked="@(PaperAnswers.ContainsKey(index) && PaperAnswers[index] == letter)"
                                                       @onchange="@(() => UpdateAnswer(index, letter))" />
                                                <strong>@letter.</strong> @option
                                            </label>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <!-- å¡«ç©ºé¢˜ï¼šæ˜¾ç¤ºè¾“å…¥æ¡† -->
                                    <input type="text" class="form-control"
                                           placeholder="è¯·è¾“å…¥ç­”æ¡ˆ..."
                                           value="@(PaperAnswers.ContainsKey(index) ? PaperAnswers[index] : "")"
                                           @oninput="@(e => UpdateAnswer(index, e.Value?.ToString() ?? ""))" />
                                }
                            </div>
                        </div>
                    }

                    <div class="d-grid gap-2 sticky-bottom bg-white p-3 border-top">
                        <button class="btn btn-success btn-lg" @onclick="SubmitPaper">
                            âœ… æäº¤è¯•å·ï¼ˆå·²å®Œæˆ @PaperAnswers.Count(p => !string.IsNullOrWhiteSpace(p.Value))/@AllQuestions.Count é¢˜ï¼‰
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="ResetToStart">è¿”å›è®¾ç½®</button>
                    </div>
                }
                else
                {
                    <!-- è¯•å·å·²æäº¤ï¼šæ˜¾ç¤ºæ‰¹æ”¹ç»“æœ -->
                    <div class="alert alert-success">
                        <h4>âœ… è¯•å·å·²æ‰¹æ”¹å®Œæˆ</h4>
                        <p class="mb-0">æ€»åˆ†ï¼š<strong>@Score</strong> / @(AllQuestions.Count * 10)  |  æ­£ç¡®ç‡ï¼š<strong>@((Asked.Count(a => a.Correct) * 100.0 / Asked.Count).ToString("F1"))%</strong></p>
                    </div>

                    @for (int i = 0; i < AllQuestions.Count; i++)
                    {
                        var question = AllQuestions[i];
                        var askedItem = Asked[i];

                        <div class="card mb-3 @(askedItem.Correct ? "border-success" : "border-danger")">
                            <div class="card-header @(askedItem.Correct ? "bg-success text-white" : "bg-danger text-white")">
                                <strong>ç¬¬ @(i + 1) é¢˜</strong>
                                @if (askedItem.Correct)
                                {
                                    <span class="float-end">âœ… æ­£ç¡® +10åˆ†</span>
                                }
                                else
                                {
                                    <span class="float-end">âŒ é”™è¯¯</span>
                                }
                            </div>
                            <div class="card-body">
                                <p><strong>é¢˜ç›®ï¼š</strong>@question.Text</p>
                                <p><strong>ä½ çš„ç­”æ¡ˆï¼š</strong>@askedItem.User</p>
                                @if (!askedItem.Correct)
                                {
                                    <p class="text-danger"><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong>@question.CorrectAnswer</p>
                                    <div class="alert alert-warning mb-0">
                                        <strong>ğŸ“ è§£æï¼š</strong>@question.Explanation
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" @onclick="StartExam">é‡æ–°æµ‹è¯•</button>
                        <a class="btn btn-info" href="/statistics/@GetStoragePrefix()">ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡æŠ¥å‘Š</a>
                        <a class="btn btn-warning" href="/wrong-questions/@GetStoragePrefix()">ğŸ“– è¿›å…¥é”™é¢˜æœ¬</a>
                        <a class="btn btn-outline-secondary" href="/">è¿”å›é¦–é¡µ</a>
                    </div>
                }
            </div>
        }
        else if (CurrentQuestion != null)
        {
            <div class="question-section">
                <div class="question-text">
                    <span class="badge bg-primary me-2">ç¬¬ @(Asked.Count + 1) é¢˜</span>
                    @CurrentQuestion.Text
                </div>

                @if (!IsSubmitted)
                {
                    @if (CurrentQuestion.Type == QuestionType.MultipleChoice)
                    {
                        <!-- é€‰æ‹©é¢˜ï¼šæ˜¾ç¤ºé€‰é¡¹æŒ‰é’® -->
                        <div class="mb-3">
                            <div class="list-group">
                                @for (int optIdx = 0; optIdx < CurrentQuestion.ShuffledOptions.Count; optIdx++)
                                {
                                    var option = CurrentQuestion.ShuffledOptions[optIdx];
                                    var letter = ((char)('A' + optIdx)).ToString();
                                    <label class="list-group-item list-group-item-action" style="cursor: pointer;">
                                        <input class="form-check-input me-2" type="radio"
                                               name="answer_@CurrentQuestion.Id"
                                               value="@letter"
                                               checked="@(UserAnswer == letter)"
                                               @onchange="@(() => UserAnswer = letter)" />
                                        <strong>@letter.</strong> @option
                                    </label>
                                }
                            </div>
                            <button class="btn btn-primary btn-lg mt-3 w-100" @onclick="SubmitAnswer" disabled="@string.IsNullOrWhiteSpace(UserAnswer)">
                                æäº¤ç­”æ¡ˆ
                            </button>
                        </div>
                    }
                    else
                    {
                        <!-- å¡«ç©ºé¢˜ï¼šæ˜¾ç¤ºè¾“å…¥æ¡† -->
                        <div class="input-group mb-3">
                            <input type="text" class="form-control form-control-lg"
                                   placeholder="è¯·è¾“å…¥ç­”æ¡ˆ..."
                                   @bind="UserAnswer"
                                   @bind:event="oninput"
                                   @onkeydown="HandleKeyDown" />
                            <button class="btn btn-primary btn-lg" @onclick="SubmitAnswer" disabled="@string.IsNullOrWhiteSpace(UserAnswer)">
                                æäº¤ç­”æ¡ˆ
                            </button>
                        </div>
                    }
                }
                else
                {
                    @if (IsCorrect)
                    {
                        <div class="success-box">
                            <h4>âœ… å›ç­”æ­£ç¡®ï¼</h4>
                            <p>åŠ  10 åˆ†ã€‚</p>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger">
                            <h4>âŒ å›ç­”é”™è¯¯</h4>
                            <p><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong>
                                @if (CurrentQuestion.Type == QuestionType.MultipleChoice)
                                {
                                    <text>@CurrentQuestion.ShuffledCorrectAnswerLetter</text>
                                }
                                else
                                {
                                    <text>@CurrentQuestion.CorrectAnswer</text>
                                }
                            </p>
                        </div>
                        <div class="explanation-box">
                            <h5>ğŸ“ é¢˜ç›®è§£æï¼š</h5>
                            @CurrentQuestion.Explanation
                        </div>
                    }

                    <div class="d-grid gap-2 mt-4">
                        @if (Asked.Count < TargetCount)
                        {
                            <button class="btn btn-success btn-lg" @onclick="NextQuestion">ä¸‹ä¸€é¢˜ â¡ï¸</button>
                        }
                        else
                        {
                            <button class="btn btn-warning btn-lg" @onclick="CompleteExam">ç»“æŸæµ‹è¯• âœ…</button>
                        }
                        <button class="btn btn-outline-primary btn-lg" @onclick="ToggleReview">å¤ä¹ åˆ—è¡¨</button>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    /// <summary>
    /// è·å–ç§‘ç›®åç§°
    /// </summary>
    protected override string GetSubjectName() => "æ•°å­¦";

    /// <summary>
    /// è·å– LocalStorage å­˜å‚¨é”®å‰ç¼€
    /// </summary>
    protected override string GetStoragePrefix() => "math";

    /// <summary>
    /// éªŒè¯æ•°å­¦ç­”æ¡ˆï¼ˆå¤„ç†åˆ†æ•°è§£æå’Œå•ä½å»é™¤ï¼‰
    /// </summary>
    protected override bool ValidateAnswer(string userAnswer, Question question)
    {
        string input = userAnswer.Trim().ToUpper();

        // å¦‚æœæ˜¯é€‰æ‹©é¢˜ï¼Œæ¯”è¾ƒå­—æ¯ç­”æ¡ˆ
        if (question.Type == QuestionType.MultipleChoice)
        {
            return input == question.ShuffledCorrectAnswerLetter;
        }

        // å¡«ç©ºé¢˜ï¼šè§„èŒƒåŒ–ç”¨æˆ·è¾“å…¥ï¼Œå»é™¤å•ä½å’Œæ ‡ç‚¹ç¬¦å·
        input = input
            .Replace("ã€‚", ".")
            .Replace("ï¼Œ", ",")
            .Replace("cm", "", StringComparison.OrdinalIgnoreCase)
            .Replace("m", "", StringComparison.OrdinalIgnoreCase)
            .Replace("å˜ç±³", "")
            .Replace("ç±³", "")
            .Replace("å¹³æ–¹", "")
            .Replace("ç«‹æ–¹", "");

        // å¦‚æœæ˜¯åˆ†æ•°ç­”æ¡ˆï¼Œä½¿ç”¨åˆ†æ•°æ¯”è¾ƒ
        if (question.IsFractionAnswer)
        {
            if (Fraction.TryParse(input, out Fraction userFrac) &&
                Fraction.TryParse(question.CorrectAnswer, out Fraction correctFrac))
            {
                return userFrac.Equals(correctFrac);
            }
            else
            {
                // åˆ†æ•°è§£æå¤±è´¥ï¼Œé€€å›åˆ°å­—ç¬¦ä¸²æ¯”è¾ƒ
                return input == question.CorrectAnswer;
            }
        }
        else
        {
            // éåˆ†æ•°ç­”æ¡ˆï¼Œç›´æ¥å­—ç¬¦ä¸²æ¯”è¾ƒ
            return input == question.CorrectAnswer;
        }
    }
}
