@page "/exam-history"
@using MathExamWeb.Data.Services
@using MathExamWeb.Data.Models
@inject StatisticsService StatsService

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìö ÂéÜÊ¨°ÊµãËØïËÆ∞ÂΩï</h2>
        <a class="btn btn-outline-secondary" href="/">ËøîÂõûÈ¶ñÈ°µ</a>
    </div>

    @if (IsLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Âä†ËΩΩ‰∏≠...</span>
            </div>
            <p class="mt-2">Ê≠£Âú®Âä†ËΩΩÊµãËØïËÆ∞ÂΩï...</p>
        </div>
    }
    else
    {
        <!-- Á≠õÈÄâÂå∫Âüü -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">üìñ ÁßëÁõÆÁ≠õÈÄâ</label>
                        <select class="form-select" @bind="SelectedSubject" @bind:event="onchange" @bind:after="ApplyFilter">
                            <option value="">ÂÖ®ÈÉ®ÁßëÁõÆ</option>
                            <option value="chinese">ËØ≠Êñá</option>
                            <option value="math">Êï∞Â≠¶</option>
                        </select>
                    </div>
                    <div class="col-md-9">
                        <div class="text-muted">
                            ÂÖ± <strong>@FilteredRecords.Count</strong> Êù°ËÆ∞ÂΩï
                            @if (!string.IsNullOrEmpty(SelectedSubject))
                            {
                                <span>ÔºàÂ∑≤Á≠õÈÄâÔºâ</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (!FilteredRecords.Any())
        {
            <div class="alert alert-info text-center">
                <h4>üìù ÊöÇÊó†ÊµãËØïËÆ∞ÂΩï</h4>
                <p>ÂÆåÊàêËá≥Â∞ë‰∏ÄÊ¨°ÊµãËØïÂêéÔºåËøôÈáåÂ∞ÜÊòæÁ§∫‰Ω†ÁöÑÊâÄÊúâÊµãËØïËÆ∞ÂΩï„ÄÇ</p>
                <a class="btn btn-primary me-2" href="/chinese">ËØ≠ÊñáÊµãËØï</a>
                <a class="btn btn-success" href="/math">Êï∞Â≠¶ÊµãËØï</a>
            </div>
        }
        else
        {
            <!-- ÊµãËØïËÆ∞ÂΩïÂàóË°® -->
            <div class="accordion" id="examHistoryAccordion">
                @foreach (var (record, index) in FilteredRecords.Select((r, i) => (r, i)))
                {
                    var recordId = $"record-{index}";
                    var subjectName = record.Subject == "chinese" ? "ËØ≠Êñá" : "Êï∞Â≠¶";
                    var subjectColor = record.Subject == "chinese" ? "info" : "success";
                    var accuracyColor = GetAccuracyColor(record.AccuracyRate);

                    <div class="accordion-item mb-2">
                        <h2 class="accordion-header" id="heading-@recordId">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapse-@recordId"
                                    aria-expanded="false"
                                    aria-controls="collapse-@recordId">
                                <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                    <div class="d-flex align-items-center gap-3">
                                        <span class="badge bg-@subjectColor fs-6">@subjectName</span>
                                        <span class="text-muted">@record.EndTime.ToString("yyyy-MM-dd HH:mm")</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-4">
                                        <span>
                                            <strong class="text-primary">@record.Score</strong>
                                            <span class="text-muted">/@(record.TotalQuestions * 10)ÂàÜ</span>
                                        </span>
                                        <span class="badge bg-@accuracyColor">
                                            Ê≠£Á°ÆÁéá @((record.AccuracyRate * 100).ToString("F1"))%
                                        </span>
                                        <span class="text-muted">
                                            @record.TotalQuestions È¢ò | @GetDifficultyText(record.Difficulty)
                                        </span>
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse-@recordId"
                             class="accordion-collapse collapse"
                             aria-labelledby="heading-@recordId"
                             data-bs-parent="#examHistoryAccordion">
                            <div class="accordion-body">
                                <!-- ËÄÉËØïÊëòË¶Å -->
                                <div class="row g-3 mb-4">
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <small class="text-muted">ÊÄªÈ¢òÊï∞</small>
                                                <h4 class="mb-0">@record.TotalQuestions</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <small class="text-muted">Á≠îÂØπ</small>
                                                <h4 class="mb-0 text-success">@record.CorrectCount</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <small class="text-muted">Á≠îÈîô</small>
                                                <h4 class="mb-0 text-danger">@(record.TotalQuestions - record.CorrectCount)</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <small class="text-muted">Áî®Êó∂</small>
                                                <h4 class="mb-0">@GetDuration(record)</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Á≠îÈ¢òËØ¶ÊÉÖ -->
                                <h5 class="mb-3">üìã Á≠îÈ¢òËØ¶ÊÉÖ</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 5%">Â∫èÂè∑</th>
                                                <th style="width: 35%">È¢òÁõÆ</th>
                                                <th style="width: 15%">‰Ω†ÁöÑÁ≠îÊ°à</th>
                                                <th style="width: 15%">Ê≠£Á°ÆÁ≠îÊ°à</th>
                                                <th style="width: 10%">ÂàÜÁ±ª</th>
                                                <th style="width: 10%">ÁªìÊûú</th>
                                                <th style="width: 10%">Áî®Êó∂</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var (answer, idx) in record.Answers.Select((a, i) => (a, i + 1)))
                                            {
                                                <tr class="@(answer.IsCorrect ? "" : "table-danger")">
                                                    <td class="text-center">@idx</td>
                                                    <td>
                                                        <div class="text-truncate" style="max-width: 400px;" title="@answer.QuestionText">
                                                            @answer.QuestionText
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="@(answer.IsCorrect ? "text-success" : "text-danger")">
                                                            <strong>@answer.UserAnswer</strong>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="text-success">
                                                            @answer.CorrectAnswer
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">@answer.Category</span>
                                                    </td>
                                                    <td class="text-center">
                                                        @if (answer.IsCorrect)
                                                        {
                                                            <span class="badge bg-success">‚úì Ê≠£Á°Æ</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-danger">‚úó ÈîôËØØ</span>
                                                        }
                                                    </td>
                                                    <td class="text-center text-muted">
                                                        @if (answer.AnsweredAt != DateTime.MinValue)
                                                        {
                                                            <small>@answer.AnsweredAt.ToString("HH:mm:ss")</small>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    private List<ExamRecord> AllRecords = new();
    private List<ExamRecord> FilteredRecords = new();
    private bool IsLoading = true;
    private string SelectedSubject = "";

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        try
        {
            AllRecords = await StatsService.GetAllRecords();
            // ÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàóÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
            AllRecords = AllRecords.OrderByDescending(r => r.EndTime).ToList();
            FilterRecords();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Âä†ËΩΩÊµãËØïËÆ∞ÂΩïÂ§±Ë¥•: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    protected override void OnParametersSet()
    {
        FilterRecords();
    }

    private void FilterRecords()
    {
        if (string.IsNullOrEmpty(SelectedSubject))
        {
            FilteredRecords = AllRecords;
        }
        else
        {
            FilteredRecords = AllRecords.Where(r => r.Subject == SelectedSubject).ToList();
        }
    }

    private void ApplyFilter()
    {
        FilterRecords();
        StateHasChanged();
    }

    private string GetDifficultyText(DifficultyLevel? difficulty)
    {
        return difficulty switch
        {
            DifficultyLevel.Easy => "ÁÆÄÂçï",
            DifficultyLevel.Medium => "‰∏≠Á≠â",
            DifficultyLevel.Hard => "Âõ∞Èöæ",
            _ => "ÈöèÊú∫"
        };
    }

    private string GetAccuracyColor(double accuracy)
    {
        if (accuracy >= 0.9) return "success";
        if (accuracy >= 0.8) return "primary";
        if (accuracy >= 0.7) return "info";
        if (accuracy >= 0.6) return "warning";
        return "danger";
    }

    private string GetDuration(ExamRecord record)
    {
        if (record.EndTime == DateTime.MinValue || record.StartTime == DateTime.MinValue)
        {
            return "-";
        }

        var duration = record.EndTime - record.StartTime;
        if (duration.TotalMinutes >= 60)
        {
            return $"{(int)duration.TotalHours}Êó∂{duration.Minutes}ÂàÜ";
        }
        else if (duration.TotalMinutes >= 1)
        {
            return $"{(int)duration.TotalMinutes}ÂàÜ{duration.Seconds}Áßí";
        }
        else
        {
            return $"{duration.Seconds}Áßí";
        }
    }
}
