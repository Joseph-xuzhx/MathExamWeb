@page "/question-import"
@using MathExamWeb.Data
@using MathExamWeb.Data.Models
@using MathExamWeb.Data.Services
@using System.Text
@inject NavigationManager Navigation
@inject AIQuestionParserService AIParser
@inject OCRService OCRService
@inject PDFService PDFService
@inject OfflineOCRService OfflineOCR
@inject QuestionRepository QuestionRepo

<div class="container">
    <div class="exam-card">
        <div class="text-center mb-4">
            <h1 class="display-6">ğŸ“š é¢˜åº“ç®¡ç†ä¸å¯¼å…¥</h1>
            <p class="text-muted">æ”¯æŒä¸Šä¼ å›¾ç‰‡æˆ–PDFæ–‡ä»¶æ‰¹é‡å¯¼å…¥é¢˜ç›®</p>
        </div>

        <div class="row">
            <!-- å·¦ä¾§ï¼šä¸Šä¼ åŒºåŸŸ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">é€‰æ‹©ç§‘ç›®</label>
                            <div class="btn-group d-flex" role="group">
                                <input type="radio" class="btn-check" name="subject" id="subjectChinese"
                                       checked="@(SelectedSubject == "chinese")"
                                       @onclick="@(() => SelectedSubject = "chinese")" />
                                <label class="btn btn-outline-info" for="subjectChinese">è¯­æ–‡</label>

                                <input type="radio" class="btn-check" name="subject" id="subjectMath"
                                       checked="@(SelectedSubject == "math")"
                                       @onclick="@(() => SelectedSubject = "math")" />
                                <label class="btn btn-outline-success" for="subjectMath">æ•°å­¦</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">å¯¼å…¥æ–¹å¼</label>
                            <div class="btn-group d-flex mb-2" role="group">
                                <input type="radio" class="btn-check" name="importMode" id="modeText"
                                       checked="@(ImportMode == "text")"
                                       @onclick="@(() => ImportMode = "text")" />
                                <label class="btn btn-outline-primary" for="modeText">
                                    ğŸ“ è§„åˆ™è§£æ
                                </label>

                                <input type="radio" class="btn-check" name="importMode" id="modeAI"
                                       checked="@(ImportMode == "ai")"
                                       @onclick="@(() => ImportMode = "ai")" />
                                <label class="btn btn-outline-success" for="modeAI">
                                    ğŸ¤– AIæ™ºèƒ½è¯†åˆ«
                                </label>

                                <input type="radio" class="btn-check" name="importMode" id="modeFile"
                                       checked="@(ImportMode == "file")"
                                       @onclick="@(() => ImportMode = "file")" />
                                <label class="btn btn-outline-warning" for="modeFile">
                                    ğŸ“¸ åœ¨çº¿OCR
                                </label>

                                <input type="radio" class="btn-check" name="importMode" id="modeOfflineOCR"
                                       checked="@(ImportMode == "offline-ocr")"
                                       @onclick="@(() => ImportMode = "offline-ocr")" />
                                <label class="btn btn-outline-danger" for="modeOfflineOCR">
                                    ğŸ”’ ç¦»çº¿OCR
                                </label>
                            </div>
                            @if (ImportMode == "offline-ocr" && !OfflineOCR.IsAvailable())
                            {
                                <div class="alert alert-warning small mt-2">
                                    âš ï¸ ç¦»çº¿OCRéœ€è¦è¯­è¨€åŒ…ã€‚å¯ç”¨è¯­è¨€ï¼š@string.Join(", ", OfflineOCR.GetAvailableLanguages())
                                </div>
                            }
                        </div>

                        @if (ImportMode == "text")
                        {
                            <div class="mb-3">
                                <label class="form-label">ç²˜è´´é¢˜ç›®æ–‡æœ¬</label>
                                <textarea class="form-control"
                                          rows="10"
                                          @bind="InputText"
                                          placeholder="è¯·ç²˜è´´é¢˜ç›®æ–‡æœ¬..."></textarea>
                                <small class="text-muted">è¯·æŒ‰ç…§å³ä¾§æ ¼å¼è¦æ±‚è¾“å…¥é¢˜ç›®</small>
                            </div>
                        }
                        else if (ImportMode == "ai")
                        {
                            <div class="mb-3">
                                <label class="form-label">API é…ç½®</label>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">ğŸŒ</span>
                                    <input type="text"
                                           class="form-control"
                                           @bind="ApiEndpoint"
                                           placeholder="APIåœ°å€ï¼ˆç•™ç©ºä½¿ç”¨å®˜æ–¹åœ°å€ï¼‰" />
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">ğŸ”‘</span>
                                    <input type="@(ShowApiKey ? "text" : "password")"
                                           class="form-control"
                                           @bind="ApiKey"
                                           placeholder="è¯·è¾“å…¥Claude API Keyï¼ˆå¦‚ï¼šsk-ant-...ï¼‰" />
                                    <button class="btn btn-outline-secondary"
                                            type="button"
                                            @onclick="ToggleApiKeyVisibility">
                                        @(ShowApiKey ? "ğŸ‘ï¸" : "ğŸ”’")
                                    </button>
                                </div>
                                <small class="text-muted">
                                    ğŸŒ æ”¯æŒè‡ªå®šä¹‰APIåœ°å€ï¼ˆå¦‚ç¬¬ä¸‰æ–¹ä»£ç†ï¼‰
                                    <br />ğŸ’¡ æ‚¨çš„é…ç½®ä»…åœ¨æµè§ˆå™¨æœ¬åœ°ä½¿ç”¨ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨
                                    <br />ğŸ”— å®˜æ–¹API: <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>
                                </small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ç²˜è´´é¢˜ç›®æ–‡æœ¬ï¼ˆä»»æ„æ ¼å¼ï¼‰</label>
                                <textarea class="form-control"
                                          rows="10"
                                          @bind="InputText"
                                          placeholder="AIå¯ä»¥è¯†åˆ«ä»»æ„æ ¼å¼çš„é¢˜ç›®ï¼Œä¾‹å¦‚ï¼š
â€¢ ä»è¯•å·å›¾ç‰‡OCRåçš„æ–‡æœ¬
â€¢ ä»Word/PDFå¤åˆ¶çš„å†…å®¹
â€¢ æ‰‹å†™æˆ–ä¸è§„èŒƒçš„æ ¼å¼
â€¢ ç¼ºå°‘é€‰é¡¹æˆ–è§£æçš„é¢˜ç›®

AIä¼šè‡ªåŠ¨æ•´ç†å’Œè¡¥å…¨é¢˜ç›®ä¿¡æ¯"></textarea>
                            </div>
                        }
                        else if (ImportMode == "offline-ocr")
                        {
                            <div class="mb-3">
                                <label class="form-label">ä¸Šä¼ å›¾ç‰‡</label>
                                <InputFile OnChange="HandleFileSelected"
                                           accept="image/*"
                                           class="form-control" />
                                <small class="text-muted">æ”¯æŒæ ¼å¼ï¼šJPGã€PNGï¼ˆæœ€å¤§10MBï¼‰</small>
                                <div class="alert alert-success mt-2 small">
                                    ğŸ”’ <strong>ç¦»çº¿OCR</strong>ï¼šä½¿ç”¨å¼€æºTesseractå¼•æ“ï¼Œå®Œå…¨æœ¬åœ°å¤„ç†ï¼Œæ— éœ€API Key
                                    <br />âœ… <strong>ä¼˜åŠ¿</strong>ï¼šå…è´¹ã€éšç§ã€ç¦»çº¿å¯ç”¨
                                    <br />âš ï¸ <strong>æ³¨æ„</strong>ï¼šéœ€è¦ä¸‹è½½å¯¹åº”çš„è¯­è¨€åŒ…ï¼ˆchi_sim.traineddataç”¨äºä¸­æ–‡ï¼‰
                                </div>
                            </div>

                            @if (OfflineOCR.IsAvailable())
                            {
                                <div class="alert alert-info small">
                                    âœ… ç¦»çº¿OCRå·²å°±ç»ª
                                    <br />å¯ç”¨è¯­è¨€ï¼š<strong>@string.Join(", ", OfflineOCR.GetAvailableLanguages())</strong>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning small">
                                    âš ï¸ æœªæ£€æµ‹åˆ°è¯­è¨€åŒ…
                                    <br />è¯·ä¸‹è½½è¯­è¨€åŒ…åˆ°ï¼š<code>tessdata/</code>ç›®å½•
                                    <br />ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/tesseract-ocr/tessdata" target="_blank">GitHub tessdata</a>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="mb-3">
                                <label class="form-label">API é…ç½®</label>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">ğŸŒ</span>
                                    <input type="text"
                                           class="form-control"
                                           @bind="ApiEndpoint"
                                           placeholder="APIåœ°å€ï¼ˆç•™ç©ºä½¿ç”¨å®˜æ–¹åœ°å€ï¼‰" />
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">ğŸ”‘</span>
                                    <input type="@(ShowApiKey ? "text" : "password")"
                                           class="form-control"
                                           @bind="ApiKey"
                                           placeholder="è¯·è¾“å…¥Claude API Keyï¼ˆå¦‚ï¼šsk-ant-...ï¼‰" />
                                    <button class="btn btn-outline-secondary"
                                            type="button"
                                            @onclick="ToggleApiKeyVisibility">
                                        @(ShowApiKey ? "ğŸ‘ï¸" : "ğŸ”’")
                                    </button>
                                </div>
                                <small class="text-muted">
                                    ğŸŒ æ”¯æŒè‡ªå®šä¹‰APIåœ°å€ï¼ˆå¦‚ç¬¬ä¸‰æ–¹ä»£ç†ï¼‰
                                    <br />ğŸ’¡ æ‚¨çš„é…ç½®ä»…åœ¨æµè§ˆå™¨æœ¬åœ°ä½¿ç”¨
                                    <br />ğŸ”— å®˜æ–¹API: <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>
                                </small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ä¸Šä¼ æ–‡ä»¶</label>
                                <InputFile OnChange="HandleFileSelected"
                                           accept="image/*,.pdf"
                                           class="form-control" />
                                <small class="text-muted">æ”¯æŒæ ¼å¼ï¼šJPGã€PNGï¼ˆæœ€å¤§10MBï¼‰</small>
                                <div class="alert alert-info mt-2 small">
                                    ğŸ“¸ <strong>åœ¨çº¿OCR</strong>ï¼šä½¿ç”¨Claude Visionè¯†åˆ«å›¾ç‰‡ä¸­çš„é¢˜ç›®æ–‡å­—
                                    <br />ğŸ“„ <strong>PDFæ–‡ä»¶</strong>ï¼šå»ºè®®å…ˆè½¬ä¸ºå›¾ç‰‡åä¸Šä¼ ï¼Œæˆ–ç›´æ¥å¤åˆ¶æ–‡å­—
                                </div>
                            </div>
                        }

                        @if (IsProcessing)
                        {
                            <div class="alert alert-info">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼Œè¯·ç¨å€™...
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(ErrorMessage))
                        {
                            <div class="alert alert-danger">
                                âŒ @ErrorMessage
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(SuccessMessage))
                        {
                            <div class="alert alert-success">
                                âœ… @SuccessMessage
                            </div>
                        }

                        <div class="d-grid gap-2">
                            @if (ImportMode == "text")
                            {
                                <button class="btn btn-primary btn-lg"
                                        @onclick="ProcessText"
                                        disabled="@(string.IsNullOrWhiteSpace(InputText) || IsProcessing)">
                                    ğŸ” è§£æé¢˜ç›®
                                </button>
                                @if (ParsedQuestions.Any())
                                {
                                    <button class="btn btn-success btn-lg"
                                            @onclick="SaveQuestions"
                                            disabled="@IsProcessing">
                                        ğŸ’¾ ä¿å­˜åˆ°é¢˜åº“ï¼ˆ@ParsedQuestions.Count é¢˜ï¼‰
                                    </button>
                                }
                            }
                            else if (ImportMode == "ai")
                            {
                                <button class="btn btn-success btn-lg"
                                        @onclick="ProcessWithAI"
                                        disabled="@(string.IsNullOrWhiteSpace(InputText) || string.IsNullOrWhiteSpace(ApiKey) || IsProcessing)">
                                    ğŸ¤– AIæ™ºèƒ½è¯†åˆ«
                                </button>
                                @if (ParsedQuestions.Any())
                                {
                                    <button class="btn btn-primary btn-lg"
                                            @onclick="SaveQuestions"
                                            disabled="@IsProcessing">
                                        ğŸ’¾ ä¿å­˜åˆ°é¢˜åº“ï¼ˆ@ParsedQuestions.Count é¢˜ï¼‰
                                    </button>
                                }
                            }
                            else
                            {
                                <button class="btn btn-primary btn-lg"
                                        @onclick="ProcessFile"
                                        disabled="@(SelectedFile == null || (ImportMode != "offline-ocr" && string.IsNullOrWhiteSpace(ApiKey)) || IsProcessing)">
                                    @if (ImportMode == "offline-ocr")
                                    {
                                        <text>ğŸ”’ ç¦»çº¿è¯†åˆ«å›¾ç‰‡å¹¶è§£æé¢˜ç›®</text>
                                    }
                                    else
                                    {
                                        <text>ğŸ“¸ è¯†åˆ«å›¾ç‰‡å¹¶è§£æé¢˜ç›®</text>
                                    }
                                </button>
                                @if (ParsedQuestions.Any())
                                {
                                    <button class="btn btn-success btn-lg"
                                            @onclick="SaveQuestions"
                                            disabled="@IsProcessing">
                                        ğŸ’¾ ä¿å­˜åˆ°é¢˜åº“ï¼ˆ@ParsedQuestions.Count é¢˜ï¼‰
                                    </button>
                                }
                            }
                            <a class="btn btn-outline-secondary" href="/">è¿”å›é¦–é¡µ</a>
                        </div>
                    </div>
                </div>

                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h6>
                    </div>
                    <div class="card-body small">
                        @if (ImportMode == "text")
                        {
                            <p class="mb-2"><strong>é¢˜ç›®æ ¼å¼è¦æ±‚ï¼š</strong></p>
                            <pre class="bg-light p-2 small">1. é¢˜ç›®æ–‡æœ¬
ç­”æ¡ˆï¼šæ­£ç¡®ç­”æ¡ˆ
è§£æï¼šé¢˜ç›®è§£æ

2. é¢˜ç›®æ–‡æœ¬
A. é€‰é¡¹A
B. é€‰é¡¹B
C. é€‰é¡¹C
D. é€‰é¡¹D
ç­”æ¡ˆï¼šA
è§£æï¼šé¢˜ç›®è§£æ</pre>
                        }
                        else if (ImportMode == "ai")
                        {
                            <p><strong>ğŸ¤– AIæ™ºèƒ½è¯†åˆ«ç‰¹ç‚¹ï¼š</strong></p>
                            <ul class="mb-2">
                                <li>âœ… ä¸éœ€è¦ä¸¥æ ¼æ ¼å¼</li>
                                <li>âœ… è‡ªåŠ¨è¡¥å…¨ç¼ºå¤±çš„é€‰é¡¹æˆ–è§£æ</li>
                                <li>âœ… è¯†åˆ«OCRåçš„æ··ä¹±æ–‡æœ¬</li>
                                <li>âœ… çº æ­£å¸¸è§æ ¼å¼é”™è¯¯</li>
                            </ul>
                            <p class="mb-0 text-muted">ä½¿ç”¨Claude 3.5 Sonnetæ¨¡å‹ï¼Œè¯†åˆ«å‡†ç¡®ç‡é«˜</p>
                        }
                        else
                        {
                            <p><strong>ğŸ“¸ å›¾ç‰‡è¯†åˆ«æµç¨‹ï¼š</strong></p>
                            <ol class="mb-2">
                                <li>é…ç½®Claude API Keyå’ŒAPIåœ°å€</li>
                                <li>ä¸Šä¼ é¢˜ç›®å›¾ç‰‡ï¼ˆJPG/PNGï¼‰</li>
                                <li>Claude Visionè‡ªåŠ¨è¯†åˆ«æ–‡å­—</li>
                                <li>Claude AIè§£æä¸ºç»“æ„åŒ–é¢˜ç›®</li>
                                <li>é¢„è§ˆå¹¶ä¿å­˜åˆ°é¢˜åº“</li>
                            </ol>
                            <p class="mb-2"><strong>æ‹ç…§æŠ€å·§ï¼š</strong></p>
                            <ul class="mb-0">
                                <li>âœ… ç¡®ä¿å…‰çº¿å……è¶³</li>
                                <li>âœ… æ–‡å­—æ¸…æ™°å¯è¯»</li>
                                <li>âœ… é¿å…å€¾æ–œå’Œé˜´å½±</li>
                                <li>âœ… å»ºè®®æ‹æ‘„å¤šé“é¢˜ç›®ä¸€èµ·ä¸Šä¼ </li>
                            </ul>
                        }
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šé¢„è§ˆåŒºåŸŸ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ğŸ‘ï¸ è¯†åˆ«é¢„è§ˆ</h5>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        @if (!string.IsNullOrEmpty(RecognizedText))
                        {
                            <h6>ğŸ“„ è¯†åˆ«çš„æ–‡æœ¬ï¼š</h6>
                            <pre class="bg-light p-3 small">@RecognizedText</pre>

                            @if (ParsedQuestions.Any())
                            {
                                <hr />
                                <h6>ğŸ“ è§£æçš„é¢˜ç›®ï¼ˆå…± @ParsedQuestions.Count é¢˜ï¼‰ï¼š</h6>
                                @foreach (var (q, index) in ParsedQuestions.Select((q, i) => (q, i + 1)))
                                {
                                    <div class="card mb-2 border-success">
                                        <div class="card-header bg-light">
                                            <strong>é¢˜ç›® @index</strong>
                                            @if (q.Type == QuestionType.MultipleChoice)
                                            {
                                                <span class="badge bg-info ms-2">é€‰æ‹©é¢˜</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success ms-2">å¡«ç©ºé¢˜</span>
                                            }
                                        </div>
                                        <div class="card-body small">
                                            <p><strong>é¢˜ç›®ï¼š</strong>@q.Text</p>
                                            @if (q.Type == QuestionType.MultipleChoice && q.Options.Any())
                                            {
                                                <p><strong>é€‰é¡¹ï¼š</strong></p>
                                                <ul class="mb-2">
                                                    @foreach (var opt in q.Options)
                                                    {
                                                        <li>@opt</li>
                                                    }
                                                </ul>
                                            }
                                            <p><strong>ç­”æ¡ˆï¼š</strong>@q.CorrectAnswer</p>
                                            <p class="mb-0"><strong>è§£æï¼š</strong>@q.Explanation</p>
                                        </div>
                                    </div>
                                }
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted py-5">
                                <i class="display-1">ğŸ“­</i>
                                <p>ä¸Šä¼ æ–‡ä»¶åï¼Œè¯†åˆ«ç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string SelectedSubject = "chinese";
    private string ImportMode = "text";
    private string InputText = "";
    private string ApiKey = "";
    private string ApiEndpoint = "https://api.anthropic.com/v1/messages";
    private bool ShowApiKey = false;
    private IBrowserFile? SelectedFile;
    private bool IsProcessing = false;
    private string ErrorMessage = "";
    private string SuccessMessage = "";
    private string RecognizedText = "";
    private List<Question> ParsedQuestions = new List<Question>();

    private void ToggleApiKeyVisibility()
    {
        ShowApiKey = !ShowApiKey;
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        SelectedFile = e.File;
        ErrorMessage = "";
        SuccessMessage = "";
        RecognizedText = "";
        ParsedQuestions.Clear();

        // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
        if (SelectedFile.Size > 10 * 1024 * 1024)
        {
            ErrorMessage = "æ–‡ä»¶å¤§å°è¶…è¿‡10MBé™åˆ¶";
            SelectedFile = null;
        }
    }

    private void ProcessText()
    {
        IsProcessing = true;
        ErrorMessage = "";
        SuccessMessage = "";
        RecognizedText = InputText;
        ParsedQuestions.Clear();

        try
        {
            ParsedQuestions = ParseQuestionsFromText(InputText);

            if (ParsedQuestions.Any())
            {
                SuccessMessage = $"æˆåŠŸè§£æ {ParsedQuestions.Count} é“é¢˜ç›®ï¼è¯·åœ¨é¢„è§ˆåŒºåŸŸç¡®è®¤åç‚¹å‡»ã€ä¿å­˜åˆ°é¢˜åº“ã€‘æŒ‰é’®ã€‚";
            }
            else
            {
                ErrorMessage = "æœªèƒ½è§£æå‡ºæœ‰æ•ˆçš„é¢˜ç›®ï¼Œè¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"è§£æé¢˜ç›®æ—¶å‡ºé”™ï¼š{ex.Message}";
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task ProcessWithAI()
    {
        IsProcessing = true;
        ErrorMessage = "";
        SuccessMessage = "";
        RecognizedText = InputText;
        ParsedQuestions.Clear();

        try
        {
            // è°ƒç”¨AIæœåŠ¡è§£æé¢˜ç›®ï¼Œä¼ é€’è‡ªå®šä¹‰APIç«¯ç‚¹
            ParsedQuestions = await AIParser.ParseQuestionsWithAI(InputText, ApiKey, "claude-3-5-sonnet-20241022", ApiEndpoint);

            if (ParsedQuestions.Any())
            {
                SuccessMessage = $"ğŸ¤– AIæˆåŠŸè¯†åˆ« {ParsedQuestions.Count} é“é¢˜ç›®ï¼è¯·åœ¨é¢„è§ˆåŒºåŸŸç¡®è®¤åç‚¹å‡»ã€ä¿å­˜åˆ°é¢˜åº“ã€‘æŒ‰é’®ã€‚";
            }
            else
            {
                ErrorMessage = "AIæœªèƒ½è¯†åˆ«å‡ºæœ‰æ•ˆçš„é¢˜ç›®ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹ã€‚";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"AIè¯†åˆ«å¤±è´¥ï¼š{ex.Message}";
            Console.WriteLine($"AI Error Details: {ex}");
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task SaveQuestions()
    {
        if (!ParsedQuestions.Any()) return;

        IsProcessing = true;
        ErrorMessage = "";
        try
        {
            // ä¸ºæ¯ä¸ªé¢˜ç›®è®¾ç½®ç§‘ç›®
            foreach (var question in ParsedQuestions)
            {
                question.Subject = SelectedSubject;
            }

            // ä¿å­˜åˆ°æ•°æ®åº“
            await QuestionRepo.AddRangeAsync(ParsedQuestions);

            SuccessMessage = $"âœ… æˆåŠŸå°† {ParsedQuestions.Count} é“é¢˜ç›®ä¿å­˜åˆ° {(SelectedSubject == "chinese" ? "è¯­æ–‡" : "æ•°å­¦")} é¢˜åº“ï¼";

            // æ¸…ç©ºå·²ä¿å­˜çš„é¢˜ç›®
            ParsedQuestions.Clear();
            InputText = "";
            RecognizedText = "";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"ä¿å­˜é¢˜ç›®æ—¶å‡ºé”™ï¼š{ex.Message}";
            Console.WriteLine($"Save Error Details: {ex}");
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task ProcessFile()
    {
        if (SelectedFile == null) return;

        IsProcessing = true;
        ErrorMessage = "";
        SuccessMessage = "";
        RecognizedText = "";
        ParsedQuestions.Clear();

        try
        {
            // è¯»å–æ–‡ä»¶å†…å®¹
            using var stream = SelectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var fileBytes = memoryStream.ToArray();

            // åˆ¤æ–­æ–‡ä»¶ç±»å‹
            string fileExtension = Path.GetExtension(SelectedFile.Name).ToLower();

            if (fileExtension == ".pdf")
            {
                // å¤„ç†PDFæ–‡ä»¶
                ErrorMessage = "PDFè¯†åˆ«åŠŸèƒ½å¼€å‘ä¸­ã€‚å»ºè®®ï¼š\n1. å°†PDFé¡µé¢æˆªå›¾åä¸Šä¼ \n2. æˆ–ç›´æ¥å¤åˆ¶PDFä¸­çš„æ–‡å­—åˆ°ã€AIæ™ºèƒ½è¯†åˆ«ã€‘æ¨¡å¼";
                return;
            }
            else if (fileExtension == ".jpg" || fileExtension == ".jpeg" || fileExtension == ".png")
            {
                // åˆ¤æ–­ä½¿ç”¨åœ¨çº¿OCRè¿˜æ˜¯ç¦»çº¿OCR
                if (ImportMode == "offline-ocr")
                {
                    // ç¦»çº¿OCRæ¨¡å¼ - ä½¿ç”¨Tesseract
                    if (!OfflineOCR.IsAvailable())
                    {
                        ErrorMessage = "ç¦»çº¿OCRæœåŠ¡ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿å·²å®‰è£…è¯­è¨€åŒ…ã€‚ä¸‹è½½åœ°å€ï¼šhttps://github.com/tesseract-ocr/tessdata";
                        return;
                    }

                    SuccessMessage = "æ­£åœ¨ä½¿ç”¨Tesseractè¯†åˆ«å›¾ç‰‡...";
                    StateHasChanged();

                    // æ­¥éª¤1: ä½¿ç”¨ç¦»çº¿OCRè¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—
                    RecognizedText = await OfflineOCR.RecognizeImageText(fileBytes, "chi_sim+eng");

                    if (string.IsNullOrWhiteSpace(RecognizedText))
                    {
                        ErrorMessage = "æœªèƒ½è¯†åˆ«å‡ºå›¾ç‰‡ä¸­çš„æ–‡å­—ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”åŒ…å«æ–‡å­—å†…å®¹ã€‚";
                        return;
                    }

                    SuccessMessage = "æ–‡å­—è¯†åˆ«å®Œæˆï¼Œæ­£åœ¨è§£æé¢˜ç›®...";
                    StateHasChanged();

                    // æ­¥éª¤2: ä½¿ç”¨è§„åˆ™è§£æè¯†åˆ«å‡ºçš„æ–‡å­—ä¸ºé¢˜ç›®
                    ParsedQuestions = ParseQuestionsFromText(RecognizedText);

                    if (ParsedQuestions.Any())
                    {
                        SuccessMessage = $"ğŸ”’ ç¦»çº¿OCRæˆåŠŸè¯†åˆ« {ParsedQuestions.Count} é“é¢˜ç›®ï¼è¯·åœ¨é¢„è§ˆåŒºåŸŸç¡®è®¤åç‚¹å‡»ã€ä¿å­˜åˆ°é¢˜åº“ã€‘æŒ‰é’®ã€‚";
                    }
                    else
                    {
                        ErrorMessage = "å·²è¯†åˆ«æ–‡å­—ï¼Œä½†æœªèƒ½è§£æå‡ºæœ‰æ•ˆçš„é¢˜ç›®ã€‚è¯†åˆ«çš„æ–‡å­—å†…å®¹å·²æ˜¾ç¤ºåœ¨å³ä¾§é¢„è§ˆåŒºã€‚\næç¤ºï¼šç¦»çº¿OCRä½¿ç”¨è§„åˆ™è§£æï¼Œè¯·ç¡®ä¿é¢˜ç›®æ ¼å¼ç¬¦åˆè¦æ±‚ã€‚";
                    }
                }
                else
                {
                    // åœ¨çº¿OCRæ¨¡å¼ - ä½¿ç”¨GPT-4 Vision OCR
                    SuccessMessage = "æ­£åœ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—...";
                    StateHasChanged();

                    // ç¡®å®šå›¾ç‰‡æ ¼å¼
                    string imageFormat = fileExtension == ".png" ? "png" : "jpeg";

                    // æ­¥éª¤1: OCRè¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—ï¼ˆä½¿ç”¨Claude Vision APIï¼‰
                    RecognizedText = await OCRService.RecognizeImageText(fileBytes, ApiKey, imageFormat, ApiEndpoint);

                    if (string.IsNullOrWhiteSpace(RecognizedText))
                    {
                        ErrorMessage = "æœªèƒ½è¯†åˆ«å‡ºå›¾ç‰‡ä¸­çš„æ–‡å­—ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”åŒ…å«æ–‡å­—å†…å®¹ã€‚";
                        return;
                    }

                    SuccessMessage = "æ–‡å­—è¯†åˆ«å®Œæˆï¼Œæ­£åœ¨è§£æé¢˜ç›®...";
                    StateHasChanged();

                    // æ­¥éª¤2: ä½¿ç”¨AIè§£æè¯†åˆ«å‡ºçš„æ–‡å­—ä¸ºé¢˜ç›®
                    ParsedQuestions = await AIParser.ParseQuestionsWithAI(RecognizedText, ApiKey, "claude-3-5-sonnet-20241022", ApiEndpoint);

                    if (ParsedQuestions.Any())
                    {
                        SuccessMessage = $"ğŸ“¸ æˆåŠŸä»å›¾ç‰‡è¯†åˆ« {ParsedQuestions.Count} é“é¢˜ç›®ï¼è¯·åœ¨é¢„è§ˆåŒºåŸŸç¡®è®¤åç‚¹å‡»ã€ä¿å­˜åˆ°é¢˜åº“ã€‘æŒ‰é’®ã€‚";
                    }
                    else
                    {
                        ErrorMessage = "å·²è¯†åˆ«æ–‡å­—ï¼Œä½†æœªèƒ½è§£æå‡ºæœ‰æ•ˆçš„é¢˜ç›®ã€‚è¯†åˆ«çš„æ–‡å­—å†…å®¹å·²æ˜¾ç¤ºåœ¨å³ä¾§é¢„è§ˆåŒºã€‚";
                    }
                }
            }
            else
            {
                ErrorMessage = "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼ JPGæˆ–PNGå›¾ç‰‡";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™ï¼š{ex.Message}";
            Console.WriteLine($"File Processing Error: {ex}");
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private List<Question> ParseQuestionsFromText(string text)
    {
        var questions = new List<Question>();
        if (string.IsNullOrWhiteSpace(text)) return questions;

        // æŒ‰é¢˜ç›®åˆ†å‰²ï¼ˆæ”¯æŒå¤šç§é¢˜å·æ ¼å¼ï¼‰
        var lines = text.Split(new[] { '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);

        Question? currentQuestion = null;
        List<string> currentOptions = new List<string>();
        bool inOptions = false;

        for (int i = 0; i < lines.Length; i++)
        {
            var line = lines[i].Trim();
            if (string.IsNullOrWhiteSpace(line)) continue;

            // æ£€æµ‹é¢˜å·ï¼ˆ1. æˆ– 1ã€ æˆ– 1) å¼€å¤´ï¼‰
            if (System.Text.RegularExpressions.Regex.IsMatch(line, @"^\d+[\.\ã€\)]"))
            {
                // ä¿å­˜ä¸Šä¸€é¢˜
                if (currentQuestion != null)
                {
                    FinalizeQuestion(currentQuestion, currentOptions, questions);
                }

                // å¼€å§‹æ–°é¢˜
                currentQuestion = new Question
                {
                    Id = Guid.NewGuid().ToString(),
                    Category = "å¯¼å…¥é¢˜ç›®",
                    Difficulty = DifficultyLevel.Medium,
                    CreatedAt = DateTime.Now
                };
                currentOptions = new List<string>();
                inOptions = false;

                // æå–é¢˜ç›®æ–‡æœ¬ï¼ˆå»æ‰é¢˜å·ï¼‰
                currentQuestion.Text = System.Text.RegularExpressions.Regex.Replace(line, @"^\d+[\.\ã€\)]\s*", "");
            }
            // æ£€æµ‹é€‰é¡¹ï¼ˆA. æˆ– Aã€ æˆ– A) å¼€å¤´ï¼‰
            else if (System.Text.RegularExpressions.Regex.IsMatch(line, @"^[A-D][\.\ã€\)]"))
            {
                inOptions = true;
                currentOptions.Add(line.Substring(2).Trim());
            }
            // æ£€æµ‹ç­”æ¡ˆè¡Œ
            else if (line.StartsWith("ç­”æ¡ˆï¼š") || line.StartsWith("ç­”æ¡ˆ:"))
            {
                if (currentQuestion != null)
                {
                    currentQuestion.CorrectAnswer = line.Substring(3).Trim();
                }
            }
            // æ£€æµ‹è§£æè¡Œ
            else if (line.StartsWith("è§£æï¼š") || line.StartsWith("è§£æ:"))
            {
                if (currentQuestion != null)
                {
                    currentQuestion.Explanation = line.Substring(3).Trim();
                }
            }
            // å…¶ä»–æƒ…å†µï¼šå¯èƒ½æ˜¯é¢˜ç›®çš„å»¶ç»­æˆ–è§£æçš„å»¶ç»­
            else if (currentQuestion != null)
            {
                if (!inOptions && string.IsNullOrEmpty(currentQuestion.CorrectAnswer))
                {
                    // é¢˜ç›®æ–‡æœ¬çš„å»¶ç»­
                    currentQuestion.Text += " " + line;
                }
                else if (!string.IsNullOrEmpty(currentQuestion.Explanation))
                {
                    // è§£æçš„å»¶ç»­
                    currentQuestion.Explanation += " " + line;
                }
            }
        }

        // ä¿å­˜æœ€åä¸€é¢˜
        if (currentQuestion != null)
        {
            FinalizeQuestion(currentQuestion, currentOptions, questions);
        }

        return questions;
    }

    private void FinalizeQuestion(Question question, List<string> options, List<Question> questions)
    {
        // åˆ¤æ–­æ˜¯é€‰æ‹©é¢˜è¿˜æ˜¯å¡«ç©ºé¢˜
        if (options.Any())
        {
            question.Type = QuestionType.MultipleChoice;
            question.Options = options.ToList();
        }
        else
        {
            question.Type = QuestionType.FillInBlank;
        }

        // è®¾ç½®é»˜è®¤å€¼
        if (string.IsNullOrWhiteSpace(question.Explanation))
        {
            question.Explanation = "æš‚æ— è§£æ";
        }

        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!string.IsNullOrWhiteSpace(question.Text) && !string.IsNullOrWhiteSpace(question.CorrectAnswer))
        {
            questions.Add(question);
        }
    }
}
