@page "/question-bank"
@using MathExamWeb.Data
@using MathExamWeb.Data.Models
@using MathExamWeb.Data.Services
@using Microsoft.JSInterop
@using Microsoft.EntityFrameworkCore
@inject QuestionRepository QuestionRepo
@inject ExcelExportService ExcelExport
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject MathExamDbContext DbContext

<div class="container">
    <div class="exam-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-6">ğŸ“š é¢˜åº“ç®¡ç†</h1>
            <div>
                <button class="btn btn-success me-2" @onclick="ExportToExcel">
                    ğŸ“¥ å¯¼å‡ºExcel
                </button>
                <button class="btn btn-warning me-2" @onclick="ShowAddQuestionModal">
                    âœï¸ æ‰‹å·¥æ·»åŠ 
                </button>
                <a href="/question-import" class="btn btn-primary me-2">
                    â• å¯¼å…¥é¢˜ç›®
                </a>
                <a href="/category-management" class="btn btn-info">
                    ğŸ“‚ åˆ†ç±»ç®¡ç†
                </a>
            </div>
        </div>

        <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
        <div class="card mb-3">
            <div class="card-body">
                <!-- ç¬¬ä¸€è¡Œï¼šåŸºç¡€ç­›é€‰ -->
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">ğŸ” å…³é”®è¯æœç´¢</label>
                        <input type="text" class="form-control" @bind="SearchKeyword"
                               placeholder="æœç´¢é¢˜ç›®æ–‡æœ¬ã€ç­”æ¡ˆ..."
                               @onkeydown="HandleSearchKeyDown" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ğŸ“– ç§‘ç›®</label>
                        <select class="form-select" @bind="FilterSubject" @bind:after="OnSubjectChanged">
                            <option value="">å…¨éƒ¨</option>
                            <option value="chinese">è¯­æ–‡</option>
                            <option value="math">æ•°å­¦</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ğŸ“ é¢˜å‹</label>
                        <select class="form-select" @bind="FilterType">
                            <option value="">å…¨éƒ¨</option>
                            <option value="MultipleChoice">é€‰æ‹©é¢˜</option>
                            <option value="FillInBlank">å¡«ç©ºé¢˜</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">â­ éš¾åº¦</label>
                        <select class="form-select" @bind="FilterDifficulty">
                            <option value="">å…¨éƒ¨</option>
                            <option value="Easy">ç®€å•</option>
                            <option value="Medium">ä¸­ç­‰</option>
                            <option value="Hard">å›°éš¾</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end gap-2">
                        <button class="btn btn-primary flex-fill" @onclick="ApplyFilters">
                            ğŸ” æŸ¥è¯¢
                        </button>
                        <button class="btn btn-outline-secondary flex-fill" @onclick="ClearFilters">
                            ğŸ”„ é‡ç½®
                        </button>
                    </div>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼šåˆ†ç±»å¤šé€‰ -->
                @if (!string.IsNullOrEmpty(FilterSubject) && AvailableCategories.Any())
                {
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">ğŸ“‚ åˆ†ç±»ï¼ˆå¯å¤šé€‰ï¼‰</label>
                            <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                @foreach (var group in AvailableCategories.GroupBy(c => c.GroupName).OrderBy(g => g.First().SortOrder))
                                {
                                    <div class="mb-2">
                                        <strong class="text-muted d-block mb-1">@group.Key</strong>
                                        <div class="d-flex flex-wrap gap-2">
                                            @foreach (var category in group.OrderBy(c => c.SortOrder))
                                            {
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox"
                                                           id="cat_@category.Id"
                                                           checked="@SelectedCategories.Contains(category.Name)"
                                                           @onchange="@(e => OnCategoryCheckChanged(category.Name, (bool)e.Value!))" />
                                                    <label class="form-check-label" for="cat_@category.Id">
                                                        @category.Name
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                            @if (SelectedCategories.Any())
                            {
                                <small class="text-muted">å·²é€‰æ‹© @SelectedCategories.Count ä¸ªåˆ†ç±»</small>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <div>
                ğŸ“Š å…±æœ‰ <strong>@FilteredQuestions.Count</strong> é“é¢˜ç›®
                @if (!string.IsNullOrEmpty(SearchKeyword) || !string.IsNullOrEmpty(FilterSubject) ||
                     !string.IsNullOrEmpty(FilterType) || !string.IsNullOrEmpty(FilterDifficulty) ||
                     SelectedCategories.Any())
                {
                    <span>ï¼ˆå·²ç­›é€‰ï¼Œæ€»è®¡ @AllQuestions.Count é“ï¼‰</span>
                }
            </div>
            <div class="d-flex align-items-center gap-2">
                <label class="mb-0">æ¯é¡µæ˜¾ç¤ºï¼š</label>
                <select class="form-select form-select-sm" style="width: auto;" value="@PageSize" @onchange="OnPageSizeChanged">
                    <option value="5">5 æ¡</option>
                    <option value="10">10 æ¡</option>
                    <option value="20">20 æ¡</option>
                    <option value="50">50 æ¡</option>
                </select>
            </div>
        </div>

        @if (IsLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <p class="mt-2">æ­£åœ¨åŠ è½½é¢˜ç›®...</p>
            </div>
        }
        else if (!FilteredQuestions.Any())
        {
            <div class="alert alert-warning text-center">
                <h4>ğŸ˜• æš‚æ— é¢˜ç›®</h4>
                <p>è¯·å…ˆå¯¼å…¥é¢˜ç›®æˆ–è°ƒæ•´ç­›é€‰æ¡ä»¶</p>
                <a href="/question-import" class="btn btn-primary">å‰å¾€å¯¼å…¥</a>
            </div>
        }
        else
        {
            <!-- é¢˜ç›®åˆ—è¡¨ -->
            <div class="row">
                @foreach (var (question, index) in PagedQuestions.Select((q, i) => (q, (CurrentPage - 1) * PageSize + i + 1)))
                {
                    <div class="col-12 mb-3">
                        <div class="card @(EditingQuestionId == question.Id ? "border-primary" : "")">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>é¢˜ç›® #@index</strong>
                                    <span class="badge bg-@(question.Subject == "chinese" ? "info" : "success") ms-2">
                                        @(question.Subject == "chinese" ? "è¯­æ–‡" : "æ•°å­¦")
                                    </span>
                                    <span class="badge bg-@(question.Type == QuestionType.MultipleChoice ? "primary" : "warning") ms-2">
                                        @(question.Type == QuestionType.MultipleChoice ? "é€‰æ‹©é¢˜" : "å¡«ç©ºé¢˜")
                                    </span>
                                    <span class="badge bg-@GetDifficultyColor(question.Difficulty) ms-2">
                                        @GetDifficultyText(question.Difficulty)
                                    </span>
                                    @if (!string.IsNullOrEmpty(question.Category))
                                    {
                                        <span class="badge bg-secondary ms-2">@question.Category</span>
                                    }
                                </div>
                                <div>
                                    <small class="text-muted">@question.CreatedAt.ToString("yyyy-MM-dd HH:mm")</small>
                                    @if (EditingQuestionId == question.Id)
                                    {
                                        <button class="btn btn-sm btn-success ms-2" @onclick="() => SaveEdit(question)">
                                            ğŸ’¾ ä¿å­˜
                                        </button>
                                        <button class="btn btn-sm btn-secondary ms-1" @onclick="CancelEdit">
                                            âŒ å–æ¶ˆ
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-primary ms-2" @onclick="() => StartEdit(question)">
                                            âœï¸ ç¼–è¾‘
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => DeleteQuestion(question.Id)">
                                            ğŸ—‘ï¸ åˆ é™¤
                                        </button>
                                    }
                                </div>
                            </div>
                            <div class="card-body">
                                @if (EditingQuestionId == question.Id && EditingQuestion != null)
                                {
                                    <!-- ç¼–è¾‘æ¨¡å¼ -->
                                    <div class="mb-3">
                                        <label class="form-label"><strong>é¢˜ç›®å†…å®¹ï¼š</strong></label>
                                        <textarea class="form-control" rows="3" @bind="EditingQuestion.Text"></textarea>
                                    </div>

                                    @if (EditingQuestion.Type == QuestionType.MultipleChoice)
                                    {
                                        <div class="mb-3">
                                            <label class="form-label"><strong>é€‰é¡¹ï¼š</strong></label>
                                            @for (int i = 0; i < EditingQuestion.Options.Count; i++)
                                            {
                                                var optIndex = i;
                                                <div class="input-group mb-2">
                                                    <span class="input-group-text">@((char)('A' + i))</span>
                                                    <input type="text" class="form-control" @bind="EditingQuestion.Options[optIndex]" />
                                                </div>
                                            }
                                        </div>
                                    }

                                    <div class="mb-3">
                                        <label class="form-label"><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong></label>
                                        <input type="text" class="form-control" @bind="EditingQuestion.CorrectAnswer" />
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label"><strong>è§£æï¼š</strong></label>
                                        <textarea class="form-control" rows="2" @bind="EditingQuestion.Explanation"></textarea>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label"><strong>éš¾åº¦ï¼š</strong></label>
                                            <select class="form-select" @bind="EditingQuestion.Difficulty">
                                                <option value="@DifficultyLevel.Easy">ç®€å•</option>
                                                <option value="@DifficultyLevel.Medium">ä¸­ç­‰</option>
                                                <option value="@DifficultyLevel.Hard">å›°éš¾</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label"><strong>åˆ†ç±»ï¼š</strong></label>
                                            <input type="text" class="form-control" @bind="EditingQuestion.Category" placeholder="å¦‚ï¼šåˆ†æ•°è¿ç®—ã€åå¥å¡«ç©º" />
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <!-- æŸ¥çœ‹æ¨¡å¼ -->
                                    <p><strong>é¢˜ç›®ï¼š</strong>@question.Text</p>

                                    @if (question.Type == QuestionType.MultipleChoice && question.Options.Any())
                                    {
                                        <p><strong>é€‰é¡¹ï¼š</strong></p>
                                        <ul class="mb-2">
                                            @for (int i = 0; i < question.Options.Count; i++)
                                            {
                                                <li><strong>@((char)('A' + i)).</strong> @question.Options[i]</li>
                                            }
                                        </ul>
                                    }

                                    <p class="mb-2">
                                        <strong>ç­”æ¡ˆï¼š</strong>
                                        <span class="text-success">@question.CorrectAnswer</span>
                                    </p>

                                    <p class="mb-0">
                                        <strong>è§£æï¼š</strong>@question.Explanation
                                    </p>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- åˆ†é¡µå¯¼èˆª -->
            @if (TotalPages > 1)
            {
                <nav aria-label="é¢˜ç›®åˆ†é¡µ" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="PreviousPage" disabled="@(CurrentPage == 1)">
                                ä¸Šä¸€é¡µ
                            </button>
                        </li>

                        @for (int i = 1; i <= TotalPages; i++)
                        {
                            var pageNum = i;
                            // æ˜¾ç¤ºé¦–é¡µã€å°¾é¡µå’Œå½“å‰é¡µé™„è¿‘çš„é¡µç 
                            if (i == 1 || i == TotalPages || (i >= CurrentPage - 2 && i <= CurrentPage + 2))
                            {
                                <li class="page-item @(CurrentPage == i ? "active" : "")">
                                    <button class="page-link" @onclick="() => GoToPage(pageNum)">
                                        @i
                                    </button>
                                </li>
                            }
                            else if (i == CurrentPage - 3 || i == CurrentPage + 3)
                            {
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            }
                        }

                        <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="NextPage" disabled="@(CurrentPage == TotalPages)">
                                ä¸‹ä¸€é¡µ
                            </button>
                        </li>
                    </ul>

                    <div class="text-center text-muted mb-3">
                        ç¬¬ @CurrentPage / @TotalPages é¡µï¼Œå…± @FilteredQuestions.Count é“é¢˜ç›®
                    </div>
                </nav>
            }
        }

        @if (!string.IsNullOrEmpty(SuccessMessage))
        {
            <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                âœ… @SuccessMessage
                <button type="button" class="btn-close" @onclick="() => SuccessMessage = string.Empty"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                âŒ @ErrorMessage
                <button type="button" class="btn-close" @onclick="() => ErrorMessage = string.Empty"></button>
            </div>
        }
    </div>
</div>

<!-- æ‰‹å·¥æ·»åŠ é¢˜ç›®æ¨¡æ€æ¡† -->
@if (ShowAddModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">âœï¸ æ‰‹å·¥æ·»åŠ é¢˜ç›®</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddQuestionModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ç§‘ç›® <span class="text-danger">*</span></label>
                        <select class="form-select" @bind="NewQuestion.Subject">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="chinese">è¯­æ–‡</option>
                            <option value="math">æ•°å­¦</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">é¢˜å‹ <span class="text-danger">*</span></label>
                        <select class="form-select" @bind="NewQuestion.Type">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="@QuestionType.MultipleChoice">é€‰æ‹©é¢˜</option>
                            <option value="@QuestionType.FillInBlank">å¡«ç©ºé¢˜</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">éš¾åº¦ <span class="text-danger">*</span></label>
                        <select class="form-select" @bind="NewQuestion.Difficulty">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="@DifficultyLevel.Easy">ç®€å•</option>
                            <option value="@DifficultyLevel.Medium">ä¸­ç­‰</option>
                            <option value="@DifficultyLevel.Hard">å›°éš¾</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">åˆ†ç±»</label>
                        <select class="form-select" @bind="NewQuestion.Category">
                            <option value="">è¯·é€‰æ‹©</option>
                            @if (NewQuestion.Subject == "math")
                            {
                                <optgroup label="åŸºç¡€è¿ç®—">
                                    <option value="åŠ æ³•">åŠ æ³•</option>
                                    <option value="å‡æ³•">å‡æ³•</option>
                                    <option value="ä¹˜æ³•">ä¹˜æ³•</option>
                                    <option value="é™¤æ³•">é™¤æ³•</option>
                                    <option value="æ··åˆè¿ç®—">æ··åˆè¿ç®—</option>
                                </optgroup>
                                <optgroup label="åˆ†æ•°è¿ç®—">
                                    <option value="åˆ†æ•°åŠ æ³•">åˆ†æ•°åŠ æ³•</option>
                                    <option value="åˆ†æ•°å‡æ³•">åˆ†æ•°å‡æ³•</option>
                                    <option value="åˆ†æ•°ä¹˜æ³•">åˆ†æ•°ä¹˜æ³•</option>
                                    <option value="åˆ†æ•°é™¤æ³•">åˆ†æ•°é™¤æ³•</option>
                                </optgroup>
                                <optgroup label="åº”ç”¨é¢˜">
                                    <option value="åº”ç”¨é¢˜-ä¹°å–">åº”ç”¨é¢˜-ä¹°å–</option>
                                    <option value="åº”ç”¨é¢˜-è·¯ç¨‹">åº”ç”¨é¢˜-è·¯ç¨‹</option>
                                    <option value="åº”ç”¨é¢˜-å·¥ç¨‹">åº”ç”¨é¢˜-å·¥ç¨‹</option>
                                    <option value="åº”ç”¨é¢˜-ç»¼åˆ">åº”ç”¨é¢˜-ç»¼åˆ</option>
                                </optgroup>
                                <optgroup label="å…¶ä»–">
                                    <option value="ç™¾åˆ†æ•°">ç™¾åˆ†æ•°</option>
                                    <option value="å°æ•°">å°æ•°</option>
                                    <option value="å‡ ä½•">å‡ ä½•</option>
                                    <option value="ç»Ÿè®¡">ç»Ÿè®¡</option>
                                    <option value="æ¯”å’Œæ¯”ä¾‹">æ¯”å’Œæ¯”ä¾‹</option>
                                </optgroup>
                            }
                            else if (NewQuestion.Subject == "chinese")
                            {
                                <optgroup label="å¤è¯—æ–‡">
                                    <option value="å¤è¯—è¯">å¤è¯—è¯</option>
                                    <option value="åå¥å¡«ç©º">åå¥å¡«ç©º</option>
                                    <option value="æ–‡è¨€æ–‡">æ–‡è¨€æ–‡</option>
                                </optgroup>
                                <optgroup label="è¯æ±‡">
                                    <option value="è¿‘ä¹‰è¯">è¿‘ä¹‰è¯</option>
                                    <option value="åä¹‰è¯">åä¹‰è¯</option>
                                    <option value="æˆè¯­">æˆè¯­</option>
                                    <option value="è¯è¯­è¾¨æ">è¯è¯­è¾¨æ</option>
                                </optgroup>
                                <optgroup label="è¯­æ³•">
                                    <option value="ä¿®è¾æ‰‹æ³•">ä¿®è¾æ‰‹æ³•</option>
                                    <option value="ç—…å¥ä¿®æ”¹">ç—…å¥ä¿®æ”¹</option>
                                    <option value="æ ‡ç‚¹ç¬¦å·">æ ‡ç‚¹ç¬¦å·</option>
                                    <option value="å¥å¼å˜æ¢">å¥å¼å˜æ¢</option>
                                </optgroup>
                                <optgroup label="é˜…è¯»ç†è§£">
                                    <option value="é˜…è¯»ç†è§£">é˜…è¯»ç†è§£</option>
                                    <option value="ç°ä»£æ–‡é˜…è¯»">ç°ä»£æ–‡é˜…è¯»</option>
                                </optgroup>
                            }
                        </select>
                        @if (string.IsNullOrEmpty(NewQuestion.Subject))
                        {
                            <small class="text-muted">è¯·å…ˆé€‰æ‹©ç§‘ç›®</small>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">é¢˜ç›®æ–‡æœ¬ <span class="text-danger">*</span></label>
                        <textarea class="form-control" rows="4" @bind="NewQuestion.Text"
                                  placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹"></textarea>
                    </div>

                    @if (NewQuestion.Type == QuestionType.MultipleChoice)
                    {
                        <div class="mb-3">
                            <label class="form-label">é€‰é¡¹ï¼ˆæ¯è¡Œä¸€ä¸ªé€‰é¡¹ï¼Œä¸éœ€è¦åŠ Aã€Bã€Cã€Dï¼‰<span class="text-danger">*</span></label>
                            <textarea class="form-control" rows="4" @bind="OptionsText"
                                      placeholder="ä¾‹å¦‚ï¼š&#10;åŒ—äº¬&#10;ä¸Šæµ·&#10;å¹¿å·&#10;æ·±åœ³"></textarea>
                            <small class="text-muted">ç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ  Aã€Bã€Cã€D æ ‡ç­¾å¹¶éšæœºæ‰“ä¹±é¡ºåº</small>
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">æ­£ç¡®ç­”æ¡ˆ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" @bind="NewQuestion.CorrectAnswer"
                               placeholder="@(NewQuestion.Type == QuestionType.MultipleChoice ? "å¡«å†™æ­£ç¡®é€‰é¡¹å†…å®¹ï¼ˆä¸æ˜¯å­—æ¯ï¼‰" : "å¡«å†™æ­£ç¡®ç­”æ¡ˆ")" />
                        @if (NewQuestion.Type == QuestionType.MultipleChoice)
                        {
                            <small class="text-muted">æ³¨æ„ï¼šè¯·å¡«å†™é€‰é¡¹çš„å®Œæ•´å†…å®¹ï¼Œè€Œä¸æ˜¯ Aã€Bã€Cã€D</small>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ç­”æ¡ˆè§£æ</label>
                        <textarea class="form-control" rows="3" @bind="NewQuestion.Explanation"
                                  placeholder="è¯·è¾“å…¥ç­”æ¡ˆè§£æï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>

                    @if (NewQuestion.Subject == "math")
                    {
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" @bind="NewQuestion.IsFractionAnswer" id="isFraction">
                                <label class="form-check-label" for="isFraction">
                                    ç­”æ¡ˆæ˜¯åˆ†æ•°ï¼ˆç”¨äºåˆ†æ•°é¢˜ç›®ï¼‰
                                </label>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddQuestionModal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveNewQuestion">ä¿å­˜é¢˜ç›®</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Question> AllQuestions = new();
    private List<Question> FilteredQuestions = new();
    private List<Question> PagedQuestions = new();

    private string SearchKeyword = "";
    private string FilterSubject = "";
    private string FilterType = "";
    private string FilterDifficulty = "";
    private List<string> SelectedCategories = new();
    private List<CategoryEntity> AvailableCategories = new();

    // åˆ†é¡µç›¸å…³
    private int CurrentPage = 1;
    private int PageSize = 10;
    private int TotalPages => (int)System.Math.Ceiling((double)FilteredQuestions.Count / PageSize);

    private bool IsLoading = false;
    private string SuccessMessage = "";
    private string ErrorMessage = "";

    // ç¼–è¾‘ç›¸å…³
    private string? EditingQuestionId = null;
    private Question? EditingQuestion = null;

    // æ‰‹å·¥æ·»åŠ ç›¸å…³
    private bool ShowAddModal = false;
    private Question NewQuestion = new();
    private string OptionsText = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadQuestions();
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        if (!string.IsNullOrEmpty(FilterSubject))
        {
            AvailableCategories = await DbContext.Categories
                .Where(c => c.Subject == FilterSubject && c.IsActive)
                .OrderBy(c => c.SortOrder)
                .ToListAsync();
        }
        else
        {
            AvailableCategories.Clear();
        }
    }

    private async Task LoadQuestions()
    {
        IsLoading = true;
        try
        {
            AllQuestions = await QuestionRepo.GetAllAsync();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"åŠ è½½é¢˜ç›®å¤±è´¥ï¼š{ex.Message}";
            Console.WriteLine($"Load Error: {ex}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void ApplyFilters()
    {
        FilteredQuestions = AllQuestions.Where(q =>
        {
            // å…³é”®è¯æœç´¢
            if (!string.IsNullOrEmpty(SearchKeyword))
            {
                var keyword = SearchKeyword.ToLower();
                if (!q.Text.ToLower().Contains(keyword) &&
                    !q.CorrectAnswer.ToLower().Contains(keyword) &&
                    !q.Explanation.ToLower().Contains(keyword))
                {
                    return false;
                }
            }

            // ç§‘ç›®ç­›é€‰
            if (!string.IsNullOrEmpty(FilterSubject) && q.Subject != FilterSubject)
                return false;

            // é¢˜å‹ç­›é€‰
            if (!string.IsNullOrEmpty(FilterType) && q.Type.ToString() != FilterType)
                return false;

            // éš¾åº¦ç­›é€‰
            if (!string.IsNullOrEmpty(FilterDifficulty) && q.Difficulty.ToString() != FilterDifficulty)
                return false;

            // åˆ†ç±»ç­›é€‰ï¼ˆå¤šé€‰ï¼‰
            if (SelectedCategories.Any() && !SelectedCategories.Contains(q.Category ?? ""))
                return false;

            return true;
        }).ToList();

        // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        CurrentPage = 1;
        UpdatePagedQuestions();

        StateHasChanged();
    }

    private void UpdatePagedQuestions()
    {
        var skip = (CurrentPage - 1) * PageSize;
        PagedQuestions = FilteredQuestions.Skip(skip).Take(PageSize).ToList();
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        CurrentPage = page;
        UpdatePagedQuestions();
        StateHasChanged();
    }

    private void PreviousPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            UpdatePagedQuestions();
            StateHasChanged();
        }
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
            UpdatePagedQuestions();
            StateHasChanged();
        }
    }

    private void OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            PageSize = newSize;
            CurrentPage = 1;
            UpdatePagedQuestions();
        }
    }

    private void ClearFilters()
    {
        SearchKeyword = "";
        FilterSubject = "";
        FilterType = "";
        FilterDifficulty = "";
        SelectedCategories.Clear();
        ApplyFilters();
    }

    private async Task OnSubjectChanged()
    {
        // å½“ç§‘ç›®æ”¹å˜æ—¶ï¼Œæ¸…ç©ºåˆ†ç±»é€‰æ‹©å¹¶é‡æ–°åŠ è½½åˆ†ç±»åˆ—è¡¨
        SelectedCategories.Clear();
        await LoadCategories();
        StateHasChanged();
    }

    private void OnCategoryCheckChanged(string categoryName, bool isChecked)
    {
        if (isChecked)
        {
            if (!SelectedCategories.Contains(categoryName))
            {
                SelectedCategories.Add(categoryName);
            }
        }
        else
        {
            SelectedCategories.Remove(categoryName);
        }
    }

    private void HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            ApplyFilters();
        }
    }

    private void StartEdit(Question question)
    {
        EditingQuestionId = question.Id;
        // æ·±æ‹·è´é¢˜ç›®ä»¥ä¾¿ç¼–è¾‘
        EditingQuestion = new Question
        {
            Id = question.Id,
            Text = question.Text,
            Type = question.Type,
            Options = new List<string>(question.Options),
            CorrectAnswer = question.CorrectAnswer,
            Explanation = question.Explanation,
            Difficulty = question.Difficulty,
            Category = question.Category,
            Subject = question.Subject,
            CreatedAt = question.CreatedAt
        };
    }

    private void CancelEdit()
    {
        EditingQuestionId = null;
        EditingQuestion = null;
    }

    private async Task SaveEdit(Question originalQuestion)
    {
        if (EditingQuestion == null) return;

        try
        {
            // æ›´æ–°åŸå§‹é¢˜ç›®
            originalQuestion.Text = EditingQuestion.Text;
            originalQuestion.Options = EditingQuestion.Options;
            originalQuestion.CorrectAnswer = EditingQuestion.CorrectAnswer;
            originalQuestion.Explanation = EditingQuestion.Explanation;
            originalQuestion.Difficulty = EditingQuestion.Difficulty;
            originalQuestion.Category = EditingQuestion.Category;

            await QuestionRepo.UpdateAsync(originalQuestion);

            SuccessMessage = "é¢˜ç›®å·²æˆåŠŸæ›´æ–°ï¼";
            EditingQuestionId = null;
            EditingQuestion = null;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"ä¿å­˜å¤±è´¥ï¼š{ex.Message}";
            Console.WriteLine($"Save Error: {ex}");
        }
    }

    private async Task DeleteQuestion(string id)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜ç›®å—ï¼Ÿ"))
            return;

        try
        {
            await QuestionRepo.DeleteAsync(id);
            AllQuestions.RemoveAll(q => q.Id == id);
            ApplyFilters();
            SuccessMessage = "é¢˜ç›®å·²æˆåŠŸåˆ é™¤ï¼";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"åˆ é™¤å¤±è´¥ï¼š{ex.Message}";
            Console.WriteLine($"Delete Error: {ex}");
        }
    }

    private async Task ExportToExcel()
    {
        try
        {
            if (!FilteredQuestions.Any())
            {
                ErrorMessage = "æ²¡æœ‰å¯å¯¼å‡ºçš„é¢˜ç›®ï¼";
                return;
            }

            // ç”Ÿæˆ Excel æ–‡ä»¶
            var excelBytes = ExcelExport.ExportQuestionsBySubjectToExcel(FilteredQuestions, "é¢˜åº“å¯¼å‡º");

            // ç”Ÿæˆæ–‡ä»¶å
            var fileName = $"é¢˜åº“å¯¼å‡º_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            // è§¦å‘æµè§ˆå™¨ä¸‹è½½
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(excelBytes));

            SuccessMessage = $"æˆåŠŸå¯¼å‡º {FilteredQuestions.Count} é“é¢˜ç›®ï¼";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"å¯¼å‡ºå¤±è´¥ï¼š{ex.Message}";
            Console.WriteLine($"Export Error: {ex}");
        }
    }

    private string GetDifficultyColor(DifficultyLevel difficulty)
    {
        return difficulty switch
        {
            DifficultyLevel.Easy => "success",
            DifficultyLevel.Medium => "warning",
            DifficultyLevel.Hard => "danger",
            _ => "secondary"
        };
    }

    private string GetDifficultyText(DifficultyLevel difficulty)
    {
        return difficulty switch
        {
            DifficultyLevel.Easy => "ç®€å•",
            DifficultyLevel.Medium => "ä¸­ç­‰",
            DifficultyLevel.Hard => "å›°éš¾",
            _ => "æœªçŸ¥"
        };
    }

    // æ‰‹å·¥æ·»åŠ é¢˜ç›®ç›¸å…³æ–¹æ³•
    private void ShowAddQuestionModal()
    {
        NewQuestion = new Question
        {
            Id = Guid.NewGuid().ToString(),
            CreatedAt = DateTime.UtcNow
        };
        OptionsText = "";
        ShowAddModal = true;
    }

    private void CloseAddQuestionModal()
    {
        ShowAddModal = false;
        NewQuestion = new();
        OptionsText = "";
    }

    private async Task SaveNewQuestion()
    {
        try
        {
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (string.IsNullOrWhiteSpace(NewQuestion.Subject))
            {
                ErrorMessage = "è¯·é€‰æ‹©ç§‘ç›®";
                return;
            }

            if (string.IsNullOrWhiteSpace(NewQuestion.Text))
            {
                ErrorMessage = "è¯·è¾“å…¥é¢˜ç›®æ–‡æœ¬";
                return;
            }

            if (string.IsNullOrWhiteSpace(NewQuestion.CorrectAnswer))
            {
                ErrorMessage = "è¯·è¾“å…¥æ­£ç¡®ç­”æ¡ˆ";
                return;
            }

            // å¤„ç†é€‰æ‹©é¢˜é€‰é¡¹
            if (NewQuestion.Type == QuestionType.MultipleChoice)
            {
                if (string.IsNullOrWhiteSpace(OptionsText))
                {
                    ErrorMessage = "è¯·è¾“å…¥é€‰é¡¹";
                    return;
                }

                var options = OptionsText.Split('\n', StringSplitOptions.RemoveEmptyEntries)
                    .Select(o => o.Trim())
                    .Where(o => !string.IsNullOrEmpty(o))
                    .ToList();

                if (options.Count < 2)
                {
                    ErrorMessage = "é€‰æ‹©é¢˜è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹";
                    return;
                }

                NewQuestion.Options = options;
            }
            else
            {
                NewQuestion.Options = new List<string>();
            }

            // ä¿å­˜åˆ°æ•°æ®åº“
            await QuestionRepo.AddAsync(NewQuestion);

            // åˆ·æ–°é¢˜ç›®åˆ—è¡¨
            await LoadQuestions();

            SuccessMessage = "é¢˜ç›®æ·»åŠ æˆåŠŸ";
            CloseAddQuestionModal();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"ä¿å­˜å¤±è´¥ï¼š{ex.Message}";
            Console.WriteLine($"Save Error: {ex}");
        }
    }
}
