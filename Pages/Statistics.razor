@page "/statistics/{Subject}"
@using MathExamWeb.Data.Services
@using MathExamWeb.Data.Models
@inject StatisticsService StatsService

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>@SubjectName ç»Ÿè®¡æŠ¥å‘Š</h2>
        <a class="btn btn-outline-secondary" href="/@SubjectRoute">è¿”å›æµ‹è¯•</a>
    </div>

    @if (IsLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
        </div>
    }
    else if (Summary == null || Summary.TotalExams == 0)
    {
        <div class="alert alert-info">
            <h4>æš‚æ— ç»Ÿè®¡æ•°æ®</h4>
            <p>å®Œæˆè‡³å°‘ä¸€æ¬¡æµ‹è¯•åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºä½ çš„å­¦ä¹ ç»Ÿè®¡ä¿¡æ¯ã€‚</p>
            <a class="btn btn-primary" href="/@SubjectRoute">å¼€å§‹æµ‹è¯•</a>
        </div>
    }
    else
    {
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted">æµ‹è¯•æ¬¡æ•°</h5>
                        <h2 class="text-primary">@Summary.TotalExams</h2>
                        <small class="text-muted">æ¬¡</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted">ç´¯è®¡ç­”é¢˜</h5>
                        <h2 class="text-info">@Summary.TotalQuestions</h2>
                        <small class="text-muted">é¢˜</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted">å¹³å‡æ­£ç¡®ç‡</h5>
                        <h2 class="text-success">@((Summary.AverageAccuracy * 100).ToString("F1"))%</h2>
                        <small class="text-muted">@GetAccuracyLevel(Summary.AverageAccuracy)</small>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title text-muted">æœ€é«˜åˆ†</h5>
                        <h2 class="text-warning">@Summary.BestScore</h2>
                        <small class="text-muted">åˆ†</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- è–„å¼±é¢˜å‹åˆ†æ -->
        @if (Summary.WeakCategories.Any())
        {
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">ğŸ“Š è–„å¼±é¢˜å‹åˆ†æ</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">ä»¥ä¸‹é¢˜å‹çš„æ­£ç¡®ç‡ä½äº 60%ï¼Œå»ºè®®é‡ç‚¹ç»ƒä¹ ï¼š</p>
                    <div class="list-group">
                        @foreach (var weak in Summary.WeakCategories.OrderBy(w => w.Value).Take(5))
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>@weak.Key</strong>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="progress" style="width: 150px; height: 20px; margin-right: 10px;">
                                            <div class="progress-bar @GetProgressBarClass(weak.Value)"
                                                 role="progressbar"
                                                 style="width: @((weak.Value * 100).ToString("F1"))%"
                                                 aria-valuenow="@((weak.Value * 100).ToString("F1"))"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100">
                                                @((weak.Value * 100).ToString("F1"))%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- æœ€è¿‘æµ‹è¯•è®°å½• -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ“ æœ€è¿‘æµ‹è¯•è®°å½•</h5>
            </div>
            <div class="card-body">
                @if (Summary.RecentRecords.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>é¢˜ç›®æ•°</th>
                                    <th>å¾—åˆ†</th>
                                    <th>æ­£ç¡®ç‡</th>
                                    <th>éš¾åº¦</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in Summary.RecentRecords)
                                {
                                    <tr>
                                        <td>@record.EndTime.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td>@record.TotalQuestions é¢˜</td>
                                        <td><strong>@record.Score</strong> / @(record.TotalQuestions * 10)</td>
                                        <td>
                                            <span class="badge @GetBadgeClass(record.AccuracyRate)">
                                                @((record.AccuracyRate * 100).ToString("F1"))%
                                            </span>
                                        </td>
                                        <td>@GetDifficultyText(record.Difficulty)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">æš‚æ— æµ‹è¯•è®°å½•</p>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string Subject { get; set; } = "";

    private StatisticsSummary? Summary;
    private bool IsLoading = true;

    private string SubjectName => Subject == "chinese" ? "è¯­æ–‡" : "æ•°å­¦";
    private string SubjectRoute => Subject == "chinese" ? "chinese" : "math";

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        try
        {
            Summary = await StatsService.GetSummary(Subject);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private string GetAccuracyLevel(double accuracy)
    {
        if (accuracy >= 0.9) return "ä¼˜ç§€";
        if (accuracy >= 0.8) return "è‰¯å¥½";
        if (accuracy >= 0.7) return "ä¸­ç­‰";
        if (accuracy >= 0.6) return "åŠæ ¼";
        return "éœ€åŠªåŠ›";
    }

    private string GetProgressBarClass(double accuracy)
    {
        if (accuracy >= 0.8) return "bg-success";
        if (accuracy >= 0.6) return "bg-warning";
        return "bg-danger";
    }

    private string GetBadgeClass(double accuracy)
    {
        if (accuracy >= 0.9) return "bg-success";
        if (accuracy >= 0.8) return "bg-primary";
        if (accuracy >= 0.7) return "bg-info";
        if (accuracy >= 0.6) return "bg-warning";
        return "bg-danger";
    }

    private string GetDifficultyText(DifficultyLevel? difficulty)
    {
        return difficulty switch
        {
            DifficultyLevel.Easy => "ç®€å•",
            DifficultyLevel.Medium => "ä¸­ç­‰",
            DifficultyLevel.Hard => "å›°éš¾",
            _ => "éšæœº"
        };
    }
}
